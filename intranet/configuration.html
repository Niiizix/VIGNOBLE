<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration - Marlowe Vineyard Intranet</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
    <style>
        /* Styles sp√©cifiques pour la gestion des utilisateurs */
        .users-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }

        .users-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .users-table th {
            background: #8B5A9F;
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .users-table td {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            color: #1a1a1a;
        }

        .users-table tr:last-child td {
            border-bottom: none;
        }

        .users-table tr:hover {
            background: #f8f9fa;
        }

        .grade-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            /* Styles dynamiques appliqu√©s via JavaScript depuis DB.json */
        }

        .search-user {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 0.8rem;
            margin-bottom: 1rem;
            width: 100%;
        }

        .search-user:focus {
            border-color: #8B5A9F;
            outline: none;
        }

        .loading-message {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
            font-style: italic;
        }

        .info-banner {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .info-banner i {
            color: #2196f3;
            font-size: 1.2rem;
        }

        .info-banner-text {
            color: #1565c0;
            font-size: 0.9rem;
        }

        .permissions-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .permission-badge {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav-container">
            <a href="../index.html" class="logo">
                <i class="fas fa-shield-alt"></i>
                Marlowe Intranet
            </a>
            <ul class="nav-menu">
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="inventaire.html">Inventaire</a></li>
                <li><a href="#commandes">Commandes</a></li>
                <li><a href="documents.html">Documents</a></li>
                <li><a href="configuration.html" class="active">Configuration</a></li>
                <li><a href="../index.html" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> D√©connexion
                </a></li>
            </ul>
        </nav>
    </header>

    <!-- Hero Section -->
    <section class="hero hero-intranet">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        
        <div class="hero-content">
            <h1>Configuration Syst√®me</h1>
            <p class="subtitle">Param√®tres de l'intranet</p>
            <p>Consultez les utilisateurs et configurez les param√®tres globaux de votre intranet.</p>
        </div>
    </section>

    <!-- Configuration Sections -->
    <section class="config-section">
        <div class="config-container">
            
            <!-- Consultation des Utilisateurs -->
            <div class="config-category">
                <div class="config-header">
                    <h2><i class="fas fa-users"></i> Utilisateurs du Syst√®me</h2>
                    <p>Consultez la liste des utilisateurs et leurs informations</p>
                </div>
                
                <div class="config-content">
                    <div class="info-banner">
                        <i class="fas fa-info-circle"></i>
                        <div class="info-banner-text">
                            <strong>Mode consultation uniquement</strong> - Pour modifier les utilisateurs, √©ditez directement le fichier DB.json
                        </div>
                    </div>

                    <div style="margin-bottom: 2rem;">
                        <input type="text" id="searchUsers" class="search-user" placeholder="üîç Rechercher un utilisateur..." style="max-width: 400px;">
                    </div>

                    <div class="users-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nom d'utilisateur</th>
                                    <th>Nom complet</th>
                                    <th>T√©l√©phone</th>
                                    <th>Grade</th>
                                    <th>Permissions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr>
                                    <td colspan="5" class="loading-message">
                                        <i class="fas fa-spinner fa-spin"></i> Chargement des utilisateurs...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Seuils de Stock -->
            <div class="config-category">
                <div class="config-header">
                    <h2><i class="fas fa-chart-bar"></i> Seuils de Stock</h2>
                    <p>Configurez les niveaux de stock qui d√©terminent les alertes dans l'inventaire</p>
                </div>
                
                <div class="config-content">
                    <div class="config-grid">
                        <!-- Mati√®res Premi√®res -->
                        <div class="config-item">
                            <h3><i class="fas fa-seedling"></i> Mati√®res Premi√®res</h3>
                            <div class="threshold-config">
                                <div class="threshold-item">
                                    <label class="form-label">
                                        <span class="status-indicator status-critical"></span>
                                        Stock Critique (en-dessous)
                                    </label>
                                    <div class="input-group">
                                        <input type="number" id="critical-matieres" class="form-input" value="50" min="0">
                                        <span class="input-suffix">unit√©s</span>
                                    </div>
                                </div>
                                
                                <div class="threshold-item">
                                    <label class="form-label">
                                        <span class="status-indicator status-warning"></span>
                                        Stock Faible (entre critique et faible)
                                    </label>
                                    <div class="input-group">
                                        <input type="number" id="warning-matieres" class="form-input" value="100" min="0">
                                        <span class="input-suffix">unit√©s</span>
                                    </div>
                                </div>
                                
                                <div class="threshold-info">
                                    <i class="fas fa-info-circle"></i>
                                    <span>Au-dessus de 100 unit√©s = <strong>Bon Stock</strong></span>
                                </div>
                            </div>
                        </div>

                        <!-- Bouteilles -->
                        <div class="config-item">
                            <h3><i class="fas fa-wine-bottle"></i> Bouteilles Finies</h3>
                            <div class="threshold-config">
                                <div class="threshold-item">
                                    <label class="form-label">
                                        <span class="status-indicator status-critical"></span>
                                        Stock Critique (en-dessous)
                                    </label>
                                    <div class="input-group">
                                        <input type="number" id="critical-bouteilles" class="form-input" value="30" min="0">
                                        <span class="input-suffix">bouteilles</span>
                                    </div>
                                </div>
                                
                                <div class="threshold-item">
                                    <label class="form-label">
                                        <span class="status-indicator status-warning"></span>
                                        Stock Faible (entre critique et faible)
                                    </label>
                                    <div class="input-group">
                                        <input type="number" id="warning-bouteilles" class="form-input" value="75" min="0">
                                        <span class="input-suffix">bouteilles</span>
                                    </div>
                                </div>
                                
                                <div class="threshold-info">
                                    <i class="fas fa-info-circle"></i>
                                    <span>Au-dessus de 75 bouteilles = <strong>Bon Stock</strong></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="config-actions">
                        <button type="button" class="cta-button btn-secondary" id="resetThresholds">
                            <i class="fas fa-undo"></i> R√©initialiser
                        </button>
                        <button type="button" class="cta-button btn-success" id="saveThresholds">
                            <i class="fas fa-save"></i> Sauvegarder
                        </button>
                    </div>
                </div>
            </div>

            <!-- Notifications -->
            <div class="config-category">
                <div class="config-header">
                    <h2><i class="fas fa-bell"></i> Notifications</h2>
                    <p>Param√®tres des notifications et alertes syst√®me</p>
                </div>
                
                <div class="config-content">
                    <div class="config-grid">
                        <div class="config-item">
                            <h3><i class="fas fa-clock"></i> Dur√©e d'affichage</h3>
                            <div class="threshold-config">
                                <div class="threshold-item">
                                    <label class="form-label">Dur√©e par d√©faut des notifications</label>
                                    <div class="input-group">
                                        <input type="number" id="notification-duration" class="form-input" value="4" min="1" max="10">
                                        <span class="input-suffix">secondes</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="config-item">
                            <h3><i class="fas fa-volume-up"></i> Alertes sonores</h3>
                            <div class="threshold-config">
                                <div class="threshold-item">
                                    <label class="form-label">
                                        <input type="checkbox" id="sound-notifications" checked>
                                        Activer les alertes sonores
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="config-actions">
                        <button type="button" class="cta-button btn-secondary" id="resetNotifications">
                            <i class="fas fa-undo"></i> R√©initialiser
                        </button>
                        <button type="button" class="cta-button btn-success" id="saveNotifications">
                            <i class="fas fa-save"></i> Sauvegarder
                        </button>
                    </div>
                </div>
            </div>

            <!-- Syst√®me -->
            <div class="config-category">
                <div class="config-header">
                    <h2><i class="fas fa-cogs"></i> Syst√®me</h2>
                    <p>Param√®tres g√©n√©raux du syst√®me</p>
                </div>
                
                <div class="config-content">
                    <div class="config-grid">
                        <div class="config-item">
                            <h3><i class="fas fa-users"></i> Sessions utilisateurs</h3>
                            <div class="threshold-config">
                                <div class="threshold-item">
                                    <label class="form-label">Dur√©e de session (inactivit√©)</label>
                                    <div class="input-group">
                                        <input type="number" id="session-timeout" class="form-input" value="60" min="15" max="480">
                                        <span class="input-suffix">minutes</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="config-item">
                            <h3><i class="fas fa-palette"></i> Th√®me</h3>
                            <div class="threshold-config">
                                <div class="threshold-item">
                                    <label class="form-label">Mode d'affichage</label>
                                    <select class="form-select" id="theme-mode">
                                        <option value="light">Clair</option>
                                        <option value="dark">Sombre</option>
                                        <option value="auto">Automatique</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="config-actions">
                        <button type="button" class="cta-button btn-secondary" id="resetSystem">
                            <i class="fas fa-undo"></i> R√©initialiser
                        </button>
                        <button type="button" class="cta-button btn-success" id="saveSystem">
                            <i class="fas fa-save"></i> Sauvegarder
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2025 Marlowe Vineyard - Intranet Priv√© | Acc√®s Restreint</p>
    </footer>

    <script src="../script.js"></script>
    <script>
        // Variables globales
        let currentUsers = {};
        let currentConfig = {};

        // === FONCTIONS UTILITAIRES ===
        function updateUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            if (Object.keys(currentUsers).length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="loading-message">Aucun utilisateur trouv√©</td></tr>';
                return;
            }

            Object.entries(currentUsers).forEach(([username, user]) => {
                // R√©cup√©rer les infos du grade depuis la DB
                const gradeInfo = window.getGradeInfo(user.grade);
                
                // Afficher les permissions sous forme de badges avec ic√¥nes
                const permissionBadges = (user.permissions || []).map(perm => {
                    const permInfo = window.getPermissionInfo(perm);
                    return `<span class="permission-badge" title="${permInfo.description || ''}">${permInfo.icon} ${permInfo.label}</span>`;
                }).join('');

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${username}</strong></td>
                    <td>${user.fullname || ''}</td>
                    <td>${user.phone || ''}</td>
                    <td>
                        <span class="grade-badge" style="
                            background: ${gradeInfo.background}; 
                            color: ${gradeInfo.color};
                            ${gradeInfo.border ? 'border: ' + gradeInfo.border + ';' : ''}
                        ">
                            ${gradeInfo.label}
                        </span>
                    </td>
                    <td>
                        <div class="permissions-list">
                            ${permissionBadges || '<span style="color: #999; font-style: italic;">Aucune permission</span>'}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadConfiguration() {
            if (!currentConfig || !currentConfig.thresholds) {
                currentConfig = {
                    thresholds: { matieres: { critical: 50, warning: 100 }, bouteilles: { critical: 30, warning: 75 } },
                    notifications: { duration: 4, soundEnabled: true },
                    system: { sessionTimeout: 60, theme: 'light' }
                };
            }
            
            const elements = {
                'critical-matieres': currentConfig.thresholds.matieres?.critical || 50,
                'warning-matieres': currentConfig.thresholds.matieres?.warning || 100,
                'critical-bouteilles': currentConfig.thresholds.bouteilles?.critical || 30,
                'warning-bouteilles': currentConfig.thresholds.bouteilles?.warning || 75,
                'notification-duration': currentConfig.notifications?.duration || 4,
                'session-timeout': currentConfig.system?.sessionTimeout || 60
            };

            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.value = value;
            });

            const soundNotifications = document.getElementById('sound-notifications');
            const themeMode = document.getElementById('theme-mode');
            
            if (soundNotifications) soundNotifications.checked = currentConfig.notifications?.soundEnabled !== false;
            if (themeMode) themeMode.value = currentConfig.system?.theme || 'light';

            updateThresholdInfo();
        }

        function updateThresholdInfo() {
            const warningMatieres = document.getElementById('warning-matieres');
            const warningBouteilles = document.getElementById('warning-bouteilles');
            
            if (!warningMatieres || !warningBouteilles) return;

            const matieresInfo = document.querySelector('.config-item:nth-child(1) .threshold-info span');
            const bouteillesInfo = document.querySelector('.config-item:nth-child(2) .threshold-info span');

            if (matieresInfo) {
                matieresInfo.innerHTML = `Au-dessus de ${warningMatieres.value} unit√©s = <strong>Bon Stock</strong>`;
            }
            if (bouteillesInfo) {
                bouteillesInfo.innerHTML = `Au-dessus de ${warningBouteilles.value} bouteilles = <strong>Bon Stock</strong>`;
            }
        }

        function addConfirmationButtons(notification, onConfirm, confirmText = 'Confirmer') {
            const notificationContent = notification.querySelector('.notification-content');
            const buttonsDiv = document.createElement('div');
            buttonsDiv.style.marginTop = '1rem';
            buttonsDiv.style.display = 'flex';
            buttonsDiv.style.gap = '0.5rem';
            
            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'cta-button btn-warning';
            confirmBtn.style.fontSize = '0.8rem';
            confirmBtn.style.padding = '0.5rem 1rem';
            confirmBtn.textContent = confirmText;
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'cta-button btn-secondary';
            cancelBtn.style.fontSize = '0.8rem';
            cancelBtn.style.padding = '0.5rem 1rem';
            cancelBtn.textContent = 'Annuler';
            
            buttonsDiv.appendChild(cancelBtn);
            buttonsDiv.appendChild(confirmBtn);
            notificationContent.appendChild(buttonsDiv);
            
            confirmBtn.addEventListener('click', () => {
                if (window.notify) window.notify.remove(notification);
                onConfirm();
            });
            
            cancelBtn.addEventListener('click', () => {
                if (window.notify) window.notify.remove(notification);
            });
        }

        // === SETUP FUNCTIONS ===
        function setupUserManagement() {
            // Recherche uniquement
            document.getElementById('searchUsers')?.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                document.querySelectorAll('#usersTableBody tr').forEach(row => {
                    if (row.querySelector('.loading-message')) return;
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(query) ? '' : 'none';
                });
            });
        }

        function setupThresholds() {
            document.getElementById('saveThresholds')?.addEventListener('click', function() {
                const newThresholds = {
                    matieres: {
                        critical: parseInt(document.getElementById('critical-matieres')?.value || 50),
                        warning: parseInt(document.getElementById('warning-matieres')?.value || 100)
                    },
                    bouteilles: {
                        critical: parseInt(document.getElementById('critical-bouteilles')?.value || 30),
                        warning: parseInt(document.getElementById('warning-bouteilles')?.value || 75)
                    }
                };

                if (newThresholds.matieres.critical >= newThresholds.matieres.warning || 
                    newThresholds.bouteilles.critical >= newThresholds.bouteilles.warning) {
                    if (window.notify) window.notify.error('Erreur', 'Le seuil critique doit √™tre inf√©rieur au seuil de stock faible.');
                    return;
                }

                // Mettre √† jour la configuration globale (sans localStorage)
                currentConfig.thresholds = newThresholds;
                window.globalConfig.thresholds = newThresholds;
                
                updateThresholdInfo();
                if (window.notify) window.notify.success('Configuration mise √† jour', 'Nouveaux seuils appliqu√©s pour cette session.');
            });

            document.getElementById('resetThresholds')?.addEventListener('click', function() {
                if (!window.notify) return;
                
                const confirmNotification = window.notify.warning('R√©initialiser les seuils', 'Remettre les valeurs par d√©faut ?', 10000);
                addConfirmationButtons(confirmNotification, () => {
                    const defaultThresholds = {
                        matieres: { critical: 50, warning: 100 },
                        bouteilles: { critical: 30, warning: 75 }
                    };
                    
                    currentConfig.thresholds = defaultThresholds;
                    window.globalConfig.thresholds = defaultThresholds;
                    loadConfiguration();
                    if (window.notify) window.notify.info('Seuils r√©initialis√©s', 'Valeurs par d√©faut restaur√©es.');
                });
            });

            ['warning-matieres', 'warning-bouteilles'].forEach(id => {
                document.getElementById(id)?.addEventListener('input', updateThresholdInfo);
            });
        }

        function setupNotifications() {
            document.getElementById('saveNotifications')?.addEventListener('click', function() {
                const newNotifications = {
                    duration: parseInt(document.getElementById('notification-duration')?.value || 4),
                    soundEnabled: document.getElementById('sound-notifications')?.checked || false
                };

                currentConfig.notifications = newNotifications;
                window.globalConfig.notifications = newNotifications;
                
                if (window.notify) window.notify.success('Configuration mise √† jour', 'Param√®tres de notification appliqu√©s pour cette session.');
            });

            document.getElementById('resetNotifications')?.addEventListener('click', function() {
                if (!window.notify) return;
                
                const confirmNotification = window.notify.warning('R√©initialiser les notifications', 'Remettre les valeurs par d√©faut ?', 10000);
                addConfirmationButtons(confirmNotification, () => {
                    const defaultNotifications = { duration: 4, soundEnabled: true };
                    currentConfig.notifications = defaultNotifications;
                    window.globalConfig.notifications = defaultNotifications;
                    loadConfiguration();
                    if (window.notify) window.notify.info('Notifications r√©initialis√©es', 'Param√®tres par d√©faut restaur√©s.');
                });
            });
        }

        function setupSystem() {
            document.getElementById('saveSystem')?.addEventListener('click', function() {
                const newSystem = {
                    sessionTimeout: parseInt(document.getElementById('session-timeout')?.value || 60),
                    theme: document.getElementById('theme-mode')?.value || 'light'
                };

                currentConfig.system = newSystem;
                window.globalConfig.system = newSystem;
                
                if (window.notify) window.notify.success('Configuration mise √† jour', 'Param√®tres syst√®me appliqu√©s pour cette session.');
            });

            document.getElementById('resetSystem')?.addEventListener('click', function() {
                if (!window.notify) return;
                
                const confirmNotification = window.notify.warning('R√©initialiser le syst√®me', 'Remettre les valeurs par d√©faut ?', 10000);
                addConfirmationButtons(confirmNotification, () => {
                    const defaultSystem = { sessionTimeout: 60, theme: 'light' };
                    currentConfig.system = defaultSystem;
                    window.globalConfig.system = defaultSystem;
                    loadConfiguration();
                    if (window.notify) window.notify.info('Syst√®me r√©initialis√©', 'Param√®tres par d√©faut restaur√©s.');
                });
            });
        }

        function setupLogout() {
            document.getElementById('logoutBtn')?.addEventListener('click', function(e) {
                e.preventDefault();
                
                if (!window.notify) return;
                
                const confirmNotification = window.notify.info('Confirmation de d√©connexion', '√ätes-vous s√ªr de vouloir vous d√©connecter ?', 10000);
                addConfirmationButtons(confirmNotification, () => {
                    if (window.notify) window.notify.info('D√©connexion en cours', 'Redirection vers l\'accueil...');
                    setTimeout(() => window.location.href = '../index.html', 1000);
                }, 'D√©connexion');
            });
        }

        // === CHARGEMENT DES DONN√âES ===
        async function loadAllData() {
            try {
                // Charger uniquement depuis DB.json (pas de localStorage)
                currentUsers = window.dbManager.getUsers();
                currentConfig = window.dbManager.getConfiguration();
                
                console.log('üë• Utilisateurs charg√©s depuis DB.json:', Object.keys(currentUsers).length);
                console.log('‚öôÔ∏è Configuration charg√©e depuis DB.json:', currentConfig);
                
                updateUsersTable();
                loadConfiguration();
                
            } catch (error) {
                console.error('‚ùå Erreur lors du chargement des donn√©es:', error);
                if (window.notify) {
                    window.notify.error('Erreur', 'Impossible de charger les donn√©es depuis DB.json.');
                }
            }
        }

        // === INITIALISATION ===
        function initConfigPage() {
            console.log('üîÑ Initialisation de la page de configuration (mode lecture seule)...');
            
            if (!window.dbManager || !window.dbManager.waitForReady) {
                console.log('‚è≥ En attente du DatabaseManager...');
                setTimeout(initConfigPage, 100);
                return;
            }
            
            console.log('üìä DatabaseManager trouv√©, attente de l\'initialisation...');
            
            window.dbManager.waitForReady().then(async () => {
                console.log('‚úÖ DatabaseManager pr√™t, chargement des donn√©es...');
                
                await loadAllData();
                
                console.log('üîß Initialisation des gestionnaires d\'√©v√©nements...');
                
                try {
                    setupUserManagement();
                    setupThresholds();
                    setupNotifications();
                    setupSystem();
                    setupLogout();
                    
                    console.log('‚úÖ Page Configuration charg√©e en mode lecture seule !');
                } catch (setupError) {
                    console.error('‚ùå Erreur lors de l\'initialisation des gestionnaires:', setupError);
                    if (window.notify) {
                        window.notify.error('Erreur', 'Probl√®me lors de l\'initialisation de l\'interface.');
                    }
                }
                
            }).catch(error => {
                console.error('‚ùå Erreur lors de l\'initialisation:', error);
                if (window.notify) {
                    window.notify.error('Erreur', 'Impossible de charger la configuration.');
                }
            });
        }

        // D√©marrer l'initialisation
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ DOM charg√©, d√©marrage de l\'initialisation en mode lecture seule...');
            initConfigPage();
        });
    </script>
</body>
</html>
