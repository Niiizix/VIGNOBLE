<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration - Marlowe Vineyard Intranet</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
    <style>
        /* Styles sp√©cifiques pour la gestion des utilisateurs */
        .users-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }

        .users-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .users-table th {
            background: #8B5A9F;
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .users-table td {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            color: #1a1a1a;
        }

        .users-table tr:last-child td {
            border-bottom: none;
        }

        .users-table tr:hover {
            background: #f8f9fa;
        }

        .grade-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .grade-employe {
            background: #e3f2fd;
            color: #1976d2;
        }

        .grade-manager {
            background: #fff3e0;
            color: #f57c00;
        }

        .grade-cfo {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .grade-ceo {
            background: #ffebee;
            color: #c62828;
            border: 2px solid #c62828;
        }

        .user-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: #17a2b8;
            color: white;
        }

        .btn-edit:hover {
            background: #138496;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .user-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-online {
            color: #28a745;
        }

        .status-offline {
            color: #6c757d;
        }

        .last-login {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .user-modal .modal-content {
            max-width: 900px;
            width: 90%;
        }

        .user-form {
            display: grid;
            gap: 1.5rem;
            padding: 2rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .user-modal .modal-content {
                max-width: 95%;
                margin: 1rem;
            }
        }

        .permissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .permission-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .search-user {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 0.8rem;
            margin-bottom: 1rem;
            width: 100%;
        }

        .search-user:focus {
            border-color: #8B5A9F;
            outline: none;
        }

        .loading-message {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav-container">
            <a href="../index.html" class="logo">
                <i class="fas fa-shield-alt"></i>
                Marlowe Intranet
            </a>
            <ul class="nav-menu">
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="inventaire.html">Inventaire</a></li>
                <li><a href="#commandes">Commandes</a></li>
                <li><a href="documents.html">Documents</a></li>
                <li><a href="configuration.html" class="active">Configuration</a></li>
                <li><a href="#" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> D√©connexion
                </a></li>
            </ul>
        </nav>
    </header>

    <!-- Hero Section -->
    <section class="hero hero-intranet">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        
        <div class="hero-content">
            <h1>Configuration Syst√®me</h1>
            <p class="subtitle">Param√®tres de l'intranet</p>
            <p>Configurez les param√®tres globaux et g√©rez les utilisateurs de votre intranet.</p>
        </div>
    </section>

    <!-- Configuration Sections -->
    <section class="config-section">
        <div class="config-container">
            
            <!-- Gestion des Utilisateurs -->
            <div class="config-category">
                <div class="config-header">
                    <h2><i class="fas fa-users"></i> Gestion des Utilisateurs</h2>
                    <p>G√©rez les comptes utilisateurs et leurs permissions d'acc√®s</p>
                </div>
                
                <div class="config-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                        <input type="text" id="searchUsers" class="search-user" placeholder="üîç Rechercher un utilisateur..." style="flex: 1; min-width: 250px;">
                        <button class="cta-button btn-success" id="addUserBtn">
                            <i class="fas fa-user-plus"></i> Ajouter Utilisateur
                        </button>
                    </div>

                    <div class="users-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nom d'utilisateur</th>
                                    <th>Nom complet</th>
                                    <th>T√©l√©phone</th>
                                    <th>Grade</th>
                                    <th>Statut</th>
                                    <th>Derni√®re connexion</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr>
                                    <td colspan="7" class="loading-message">
                                        <i class="fas fa-spinner fa-spin"></i> Chargement des utilisateurs...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="config-actions">
                        <button type="button" class="cta-button btn-info" id="exportUsers">
                            <i class="fas fa-download"></i> Exporter Liste
                        </button>
                        <button type="button" class="cta-button btn-warning" id="resetPasswords">
                            <i class="fas fa-key"></i> R√©initialiser Mots de Passe
                        </button>
                    </div>
                </div>
            </div>

            <!-- Seuils de Stock -->
            <div class="config-category">
                <div class="config-header">
                    <h2><i class="fas fa-chart-bar"></i> Seuils de Stock</h2>
                    <p>Configurez les niveaux de stock qui d√©terminent les alertes dans l'inventaire</p>
                </div>
                
                <div class="config-content">
                    <div class="config-grid">
                        <!-- Mati√®res Premi√®res -->
                        <div class="config-item">
                            <h3><i class="fas fa-seedling"></i> Mati√®res Premi√®res</h3>
                            <div class="threshold-config">
                                <div class="threshold-item">
                                    <label class="form-label">
                                        <span class="status-indicator status-critical"></span>
                                        Stock Critique (en-dessous)
                                    </label>
                                    <div class="input-group">
                                        <input type="number" id="critical-matieres" class="form-input" value="50" min="0">
                                        <span class="input-suffix">unit√©s</span>
                                    </div>
                                </div>
                                
                                <div class="threshold-item">
                                    <label class="form-label">
                                        <span class="status-indicator status-warning"></span>
                                        Stock Faible (entre critique et faible)
                                    </label>
                                    <div class="input-group">
                                        <input type="number" id="warning-matieres" class="form-input" value="100" min="0">
                                        <span class="input-suffix">unit√©s</span>
                                    </div>
                                </div>
                                
                                <div class="threshold-info">
                                    <i class="fas fa-info-circle"></i>
                                    <span>Au-dessus de 100 unit√©s = <strong>Bon Stock</strong></span>
                                </div>
                            </div>
                        </div>

                        <!-- Bouteilles -->
                        <div class="config-item">
                            <h3><i class="fas fa-wine-bottle"></i> Bouteilles Finies</h3>
                            <div class="threshold-config">
                                <div class="threshold-item">
                                    <label class="form-label">
                                        <span class="status-indicator status-critical"></span>
                                        Stock Critique (en-dessous)
                                    </label>
                                    <div class="input-group">
                                        <input type="number" id="critical-bouteilles" class="form-input" value="30" min="0">
                                        <span class="input-suffix">bouteilles</span>
                                    </div>
                                </div>
                                
                                <div class="threshold-item">
                                    <label class="form-label">
                                        <span class="status-indicator status-warning"></span>
                                        Stock Faible (entre critique et faible)
                                    </label>
                                    <div class="input-group">
                                        <input type="number" id="warning-bouteilles" class="form-input" value="75" min="0">
                                        <span class="input-suffix">bouteilles</span>
                                    </div>
                                </div>
                                
                                <div class="threshold-info">
                                    <i class="fas fa-info-circle"></i>
                                    <span>Au-dessus de 75 bouteilles = <strong>Bon Stock</strong></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="config-actions">
                        <button type="button" class="cta-button btn-secondary" id="resetThresholds">
                            <i class="fas fa-undo"></i> R√©initialiser
                        </button>
                        <button type="button" class="cta-button btn-success" id="saveThresholds">
                            <i class="fas fa-save"></i> Sauvegarder
                        </button>
                    </div>
                </div>
            </div>

            <!-- Notifications -->
            <div class="config-category">
                <div class="config-header">
                    <h2><i class="fas fa-bell"></i> Notifications</h2>
                    <p>Param√®tres des notifications et alertes syst√®me</p>
                </div>
                
                <div class="config-content">
                    <div class="config-grid">
                        <div class="config-item">
                            <h3><i class="fas fa-clock"></i> Dur√©e d'affichage</h3>
                            <div class="threshold-config">
                                <div class="threshold-item">
                                    <label class="form-label">Dur√©e par d√©faut des notifications</label>
                                    <div class="input-group">
                                        <input type="number" id="notification-duration" class="form-input" value="4" min="1" max="10">
                                        <span class="input-suffix">secondes</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="config-item">
                            <h3><i class="fas fa-volume-up"></i> Alertes sonores</h3>
                            <div class="threshold-config">
                                <div class="threshold-item">
                                    <label class="form-label">
                                        <input type="checkbox" id="sound-notifications" checked>
                                        Activer les alertes sonores
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="config-actions">
                        <button type="button" class="cta-button btn-secondary" id="resetNotifications">
                            <i class="fas fa-undo"></i> R√©initialiser
                        </button>
                        <button type="button" class="cta-button btn-success" id="saveNotifications">
                            <i class="fas fa-save"></i> Sauvegarder
                        </button>
                    </div>
                </div>
            </div>

            <!-- Syst√®me -->
            <div class="config-category">
                <div class="config-header">
                    <h2><i class="fas fa-cogs"></i> Syst√®me</h2>
                    <p>Param√®tres g√©n√©raux du syst√®me</p>
                </div>
                
                <div class="config-content">
                    <div class="config-grid">
                        <div class="config-item">
                            <h3><i class="fas fa-users"></i> Sessions utilisateurs</h3>
                            <div class="threshold-config">
                                <div class="threshold-item">
                                    <label class="form-label">Dur√©e de session (inactivit√©)</label>
                                    <div class="input-group">
                                        <input type="number" id="session-timeout" class="form-input" value="60" min="15" max="480">
                                        <span class="input-suffix">minutes</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="config-item">
                            <h3><i class="fas fa-palette"></i> Th√®me</h3>
                            <div class="threshold-config">
                                <div class="threshold-item">
                                    <label class="form-label">Mode d'affichage</label>
                                    <select class="form-select" id="theme-mode">
                                        <option value="light">Clair</option>
                                        <option value="dark">Sombre</option>
                                        <option value="auto">Automatique</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="config-actions">
                        <button type="button" class="cta-button btn-secondary" id="resetSystem">
                            <i class="fas fa-undo"></i> R√©initialiser
                        </button>
                        <button type="button" class="cta-button btn-success" id="saveSystem">
                            <i class="fas fa-save"></i> Sauvegarder
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Modal pour utilisateur -->
    <div id="userModal" class="modal user-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userModalTitle">Modifier Utilisateur</h3>
                <span class="modal-close" id="closeUserModal">&times;</span>
            </div>
            <form id="userForm" class="user-form">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Nom d'utilisateur *</label>
                        <input type="text" id="user-username" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nom complet *</label>
                        <input type="text" id="user-fullname" class="form-input" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">T√©l√©phone *</label>
                        <input type="tel" id="user-phone" class="form-input" required placeholder="+1 (555) 000-0000">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Grade *</label>
                        <select id="user-grade" class="form-select" required>
                            <option value="employe">Employ√©</option>
                            <option value="manager">Manager</option>
                            <option value="cfo">CFO</option>
                            <option value="ceo">CEO</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Code d'acc√®s</label>
                        <input type="password" id="user-password" class="form-input" placeholder="Laisser vide pour ne pas changer">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirmer le code</label>
                        <input type="password" id="user-password-confirm" class="form-input" placeholder="Confirmer le code d'acc√®s">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Description / R√¥le *</label>
                    <input type="text" id="user-description" class="form-input" required placeholder="ex: Responsable production">
                </div>

                <div class="form-group">
                    <label class="form-label">Adresse compl√®te</label>
                    <textarea id="user-address" class="form-textarea" rows="3" placeholder="Adresse, code postal, ville, pays"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Date d'embauche</label>
                        <input type="date" id="user-hire-date" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">D√©partement</label>
                        <select id="user-department" class="form-select">
                            <option value="">S√©lectionner un d√©partement</option>
                            <option value="direction">Direction</option>
                            <option value="production">Production</option>
                            <option value="ventes">Ventes & Marketing</option>
                            <option value="administration">Administration</option>
                            <option value="technique">Technique</option>
                            <option value="qualite">Qualit√©</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Salaire (optionnel)</label>
                        <input type="number" id="user-salary" class="form-input" placeholder="Salaire annuel en $">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Manager direct</label>
                        <select id="user-manager" class="form-select">
                            <!-- Options charg√©es dynamiquement depuis la DB -->
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Permissions d'acc√®s</label>
                    <div class="permissions-grid">
                        <div class="permission-item">
                            <input type="checkbox" id="perm-dashboard" checked>
                            <label for="perm-dashboard">üìä Dashboard</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm-inventory">
                            <label for="perm-inventory">üì¶ Inventaire</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm-documents">
                            <label for="perm-documents">üìÑ Documents</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm-config">
                            <label for="perm-config">‚öôÔ∏è Configuration</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm-reports">
                            <label for="perm-reports">üìà Rapports</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm-users">
                            <label for="perm-users">üë• Gestion utilisateurs</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Notes additionnelles</label>
                    <textarea id="user-notes" class="form-textarea" rows="3" placeholder="Informations compl√©mentaires, certifications, comp√©tences sp√©ciales..."></textarea>
                </div>

                <div class="config-actions">
                    <button type="button" class="cta-button btn-secondary" id="cancelUser">Annuler</button>
                    <button type="submit" class="cta-button btn-success" id="saveUser">
                        <i class="fas fa-save"></i> Sauvegarder
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2025 Marlowe Vineyard - Intranet Priv√© | Acc√®s Restreint</p>
    </footer>

    <script src="../script.js"></script>
    <script>
        // Variables globales
        let currentUsers = {};
        let currentConfig = {};
        let isEditMode = false;
        let editingUsername = '';

        // === FONCTIONS UTILITAIRES ===
        function updateUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            if (Object.keys(currentUsers).length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="loading-message">Aucun utilisateur trouv√©</td></tr>';
                return;
            }

            Object.entries(currentUsers).forEach(([username, user]) => {
                const gradeClass = `grade-${user.grade}`;
                const statusIcon = user.status === 'online' ? 'status-online' : 'status-offline';
                const statusText = user.status === 'online' ? 'En ligne' : 'Hors ligne';
                const canDelete = username !== 'admin';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>${username}</strong>
                        <div style="font-size: 0.8rem; color: #6c757d;">${user.description || ''}</div>
                    </td>
                    <td>${user.fullname || ''}</td>
                    <td>${user.phone || ''}</td>
                    <td><span class="grade-badge ${gradeClass}">${(user.grade || 'employe').toUpperCase()}</span></td>
                    <td>
                        <div class="user-status">
                            <i class="fas fa-circle ${statusIcon}"></i>
                            <span>${statusText}</span>
                        </div>
                    </td>
                    <td class="last-login">${user.lastLogin || 'Jamais'}</td>
                    <td>
                        <div class="user-actions">
                            <button class="btn-small btn-edit" onclick="editUser('${username}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${canDelete ? `<button class="btn-small btn-delete" onclick="deleteUser('${username}')">
                                <i class="fas fa-trash"></i>
                            </button>` : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadConfiguration() {
            if (!currentConfig || !currentConfig.thresholds) {
                currentConfig = {
                    thresholds: { matieres: { critical: 50, warning: 100 }, bouteilles: { critical: 30, warning: 75 } },
                    notifications: { duration: 4, soundEnabled: true },
                    system: { sessionTimeout: 60, theme: 'light' }
                };
            }
            
            const elements = {
                'critical-matieres': currentConfig.thresholds.matieres?.critical || 50,
                'warning-matieres': currentConfig.thresholds.matieres?.warning || 100,
                'critical-bouteilles': currentConfig.thresholds.bouteilles?.critical || 30,
                'warning-bouteilles': currentConfig.thresholds.bouteilles?.warning || 75,
                'notification-duration': currentConfig.notifications?.duration || 4,
                'session-timeout': currentConfig.system?.sessionTimeout || 60
            };

            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.value = value;
            });

            const soundNotifications = document.getElementById('sound-notifications');
            const themeMode = document.getElementById('theme-mode');
            
            if (soundNotifications) soundNotifications.checked = currentConfig.notifications?.soundEnabled !== false;
            if (themeMode) themeMode.value = currentConfig.system?.theme || 'light';

            updateThresholdInfo();
        }

        function updateThresholdInfo() {
            const warningMatieres = document.getElementById('warning-matieres');
            const warningBouteilles = document.getElementById('warning-bouteilles');
            
            if (!warningMatieres || !warningBouteilles) return;

            const matieresInfo = document.querySelector('.config-item:nth-child(1) .threshold-info span');
            const bouteillesInfo = document.querySelector('.config-item:nth-child(2) .threshold-info span');

            if (matieresInfo) {
                matieresInfo.innerHTML = `Au-dessus de ${warningMatieres.value} unit√©s = <strong>Bon Stock</strong>`;
            }
            if (bouteillesInfo) {
                bouteillesInfo.innerHTML = `Au-dessus de ${warningBouteilles.value} bouteilles = <strong>Bon Stock</strong>`;
            }
        }

        function addConfirmationButtons(notification, onConfirm, confirmText = 'Confirmer') {
            const notificationContent = notification.querySelector('.notification-content');
            const buttonsDiv = document.createElement('div');
            buttonsDiv.style.marginTop = '1rem';
            buttonsDiv.style.display = 'flex';
            buttonsDiv.style.gap = '0.5rem';
            
            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'cta-button btn-warning';
            confirmBtn.style.fontSize = '0.8rem';
            confirmBtn.style.padding = '0.5rem 1rem';
            confirmBtn.textContent = confirmText;
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'cta-button btn-secondary';
            cancelBtn.style.fontSize = '0.8rem';
            cancelBtn.style.padding = '0.5rem 1rem';
            cancelBtn.textContent = 'Annuler';
            
            buttonsDiv.appendChild(cancelBtn);
            buttonsDiv.appendChild(confirmBtn);
            notificationContent.appendChild(buttonsDiv);
            
            confirmBtn.addEventListener('click', () => {
                if (window.notify) window.notify.remove(notification);
                onConfirm();
            });
            
            cancelBtn.addEventListener('click', () => {
                if (window.notify) window.notify.remove(notification);
            });
        }

        // === GESTION UTILISATEURS ===
        function populateManagerSelect() {
            const managerSelect = document.getElementById('user-manager');
            if (!managerSelect) return;
            
            managerSelect.innerHTML = '<option value="">Aucun manager</option>';
            
            Object.entries(currentUsers).forEach(([username, user]) => {
                if (user.grade === 'ceo' || user.grade === 'cfo' || user.grade === 'manager') {
                    const option = document.createElement('option');
                    option.value = username;
                    option.textContent = `${user.fullname} (${user.grade.toUpperCase()})`;
                    managerSelect.appendChild(option);
                }
            });
        }

        function saveUserData() {
            const username = document.getElementById('user-username').value.trim();
            const fullname = document.getElementById('user-fullname').value.trim();
            const phone = document.getElementById('user-phone').value.trim();
            const grade = document.getElementById('user-grade').value;
            const password = document.getElementById('user-password').value;
            const passwordConfirm = document.getElementById('user-password-confirm').value;
            const description = document.getElementById('user-description').value.trim();

            // Validation
            if (!username || !fullname || !phone || !grade || !description) {
                if (window.notify) window.notify.error('Erreur', 'Veuillez remplir tous les champs obligatoires.');
                return;
            }

            if (password && password !== passwordConfirm) {
                if (window.notify) window.notify.error('Erreur', 'Les mots de passe ne correspondent pas.');
                return;
            }

            if (!isEditMode && currentUsers[username]) {
                if (window.notify) window.notify.error('Erreur', 'Cet utilisateur existe d√©j√†.');
                return;
            }

            // Collecter les permissions
            const permissions = [];
            ['dashboard', 'inventory', 'documents', 'config', 'reports', 'users'].forEach(perm => {
                if (document.getElementById(`perm-${perm}`)?.checked) permissions.push(perm);
            });

            // Cr√©er l'objet utilisateur
            const userData = {
                fullname, phone, grade, description,
                password: password || currentUsers[username]?.password || 'TEMP123',
                status: currentUsers[username]?.status || 'offline',
                lastLogin: currentUsers[username]?.lastLogin || 'Jamais',
                permissions,
                address: document.getElementById('user-address')?.value.trim() || '',
                hireDate: document.getElementById('user-hire-date')?.value || '',
                department: document.getElementById('user-department')?.value || '',
                salary: parseInt(document.getElementById('user-salary')?.value) || 0,
                manager: document.getElementById('user-manager')?.value || '',
                notes: document.getElementById('user-notes')?.value.trim() || ''
            };

            const saved = window.dbManager.saveUser(username, userData);
            
            if (saved) {
                currentUsers = window.dbManager.getUsers();
                updateUsersTable();
                document.getElementById('userModal').style.display = 'none';
                
                const action = isEditMode ? 'modifi√©' : 'ajout√©';
                if (window.notify) window.notify.success('Succ√®s', `Utilisateur ${action} avec succ√®s !`);
            } else {
                if (window.notify) window.notify.error('Erreur', 'Impossible de sauvegarder l\'utilisateur.');
            }
        }

        // Fonctions globales
        window.editUser = function(username) {
            const user = currentUsers[username];
            if (!user) return;

            isEditMode = true;
            editingUsername = username;
            
            document.getElementById('userModalTitle').textContent = 'Modifier Utilisateur';
            document.getElementById('saveUser').innerHTML = '<i class="fas fa-save"></i> Sauvegarder';
            
            // Remplir le formulaire
            const fields = {
                'user-username': username,
                'user-fullname': user.fullname || '',
                'user-phone': user.phone || '',
                'user-grade': user.grade || 'employe',
                'user-description': user.description || '',
                'user-address': user.address || '',
                'user-hire-date': user.hireDate || '',
                'user-department': user.department || '',
                'user-salary': user.salary || '',
                'user-notes': user.notes || ''
            };

            Object.entries(fields).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.value = value;
            });

            // Vider les mots de passe
            document.getElementById('user-password').value = '';
            document.getElementById('user-password-confirm').value = '';

            populateManagerSelect();
            document.getElementById('user-manager').value = user.manager || '';

            // Permissions
            const permissions = user.permissions || [];
            ['dashboard', 'inventory', 'documents', 'config', 'reports', 'users'].forEach(perm => {
                const element = document.getElementById(`perm-${perm}`);
                if (element) element.checked = permissions.includes(perm);
            });

            document.getElementById('userModal').style.display = 'flex';
        };

        window.deleteUser = function(username) {
            if (username === 'admin') {
                if (window.notify) window.notify.error('Action interdite', 'Impossible de supprimer le compte administrateur.');
                return;
            }

            if (!window.notify) return;

            const confirmNotification = window.notify.warning(
                `Supprimer ${username}`, 
                'Cette action est irr√©versible. Confirmer la suppression ?', 
                10000
            );
            
            addConfirmationButtons(confirmNotification, () => {
                const deleted = window.dbManager.deleteUser(username);
                if (deleted) {
                    currentUsers = window.dbManager.getUsers();
                    updateUsersTable();
                    if (window.notify) window.notify.success('Utilisateur supprim√©', `${username} a √©t√© supprim√© de la base.`);
                } else {
                    if (window.notify) window.notify.error('Erreur', 'Impossible de supprimer l\'utilisateur.');
                }
            });
        };

        // === SETUP FUNCTIONS ===
        function setupUserManagement() {
            const userModal = document.getElementById('userModal');
            const userForm = document.getElementById('userForm');

            // Ajouter utilisateur
            document.getElementById('addUserBtn')?.addEventListener('click', function() {
                isEditMode = false;
                document.getElementById('userModalTitle').textContent = 'Ajouter Utilisateur';
                document.getElementById('saveUser').innerHTML = '<i class="fas fa-plus"></i> Ajouter';
                userForm.reset();
                document.getElementById('perm-dashboard').checked = true;
                populateManagerSelect();
                userModal.style.display = 'flex';
            });

            // Fermer modal
            document.getElementById('closeUserModal')?.addEventListener('click', () => userModal.style.display = 'none');
            document.getElementById('cancelUser')?.addEventListener('click', () => userModal.style.display = 'none');

            // Formulaire
            userForm?.addEventListener('submit', function(e) {
                e.preventDefault();
                saveUserData();
            });

            // Recherche
            document.getElementById('searchUsers')?.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                document.querySelectorAll('#usersTableBody tr').forEach(row => {
                    if (row.querySelector('.loading-message')) return;
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(query) ? '' : 'none';
                });
            });

            // Export CSV
            document.getElementById('exportUsers')?.addEventListener('click', function() {
                const users = Object.entries(currentUsers).map(([username, data]) => 
                    `${username},"${data.fullname}",${data.phone},${data.grade},"${data.description}",${data.status},"${data.lastLogin}",${data.department || ''},${data.salary || 0}`
                );

                const csvContent = "data:text/csv;charset=utf-8,Nom d'utilisateur,Nom complet,T√©l√©phone,Grade,Description,Statut,Derni√®re connexion,D√©partement,Salaire\n" + users.join('\n');
                const link = document.createElement('a');
                link.href = encodeURI(csvContent);
                link.download = `marlowe_users_export_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();

                if (window.notify) window.notify.success('Export r√©ussi', 'Liste des utilisateurs export√©e en CSV.');
            });

            // Reset passwords
            document.getElementById('resetPasswords')?.addEventListener('click', function() {
                if (!window.notify) return;
                
                const confirmNotification = window.notify.warning(
                    'Confirmation dangereuse', 
                    'R√©initialiser TOUS les mots de passe ? Cette action est irr√©versible.', 
                    15000
                );
                
                addConfirmationButtons(confirmNotification, () => {
                    Object.keys(currentUsers).forEach(username => {
                        if (username !== 'admin') {
                            const user = currentUsers[username];
                            user.password = 'RESET2025';
                            window.dbManager.saveUser(username, user);
                        }
                    });
                    
                    currentUsers = window.dbManager.getUsers();
                    if (window.notify) window.notify.info('Mots de passe r√©initialis√©s', 'Nouveau mot de passe temporaire: RESET2025');
                });
            });
        }

        function setupThresholds() {
            document.getElementById('saveThresholds')?.addEventListener('click', function() {
                const newThresholds = {
                    matieres: {
                        critical: parseInt(document.getElementById('critical-matieres')?.value || 50),
                        warning: parseInt(document.getElementById('warning-matieres')?.value || 100)
                    },
                    bouteilles: {
                        critical: parseInt(document.getElementById('critical-bouteilles')?.value || 30),
                        warning: parseInt(document.getElementById('warning-bouteilles')?.value || 75)
                    }
                };

                if (newThresholds.matieres.critical >= newThresholds.matieres.warning || 
                    newThresholds.bouteilles.critical >= newThresholds.bouteilles.warning) {
                    if (window.notify) window.notify.error('Erreur', 'Le seuil critique doit √™tre inf√©rieur au seuil de stock faible.');
                    return;
                }

                const saved = window.dbManager.updateConfiguration('thresholds', newThresholds);
                
                if (saved) {
                    currentConfig.thresholds = newThresholds;
                    updateThresholdInfo();
                    if (window.notify) window.notify.success('Configuration sauvegard√©e', 'Nouveaux seuils appliqu√©s.');
                } else {
                    if (window.notify) window.notify.error('Erreur', 'Impossible de sauvegarder la configuration.');
                }
            });

            document.getElementById('resetThresholds')?.addEventListener('click', function() {
                if (!window.notify) return;
                
                const confirmNotification = window.notify.warning('R√©initialiser les seuils', 'Remettre les valeurs par d√©faut ?', 10000);
                addConfirmationButtons(confirmNotification, () => {
                    const defaultThresholds = {
                        matieres: { critical: 50, warning: 100 },
                        bouteilles: { critical: 30, warning: 75 }
                    };
                    
                    const saved = window.dbManager.updateConfiguration('thresholds', defaultThresholds);
                    if (saved) {
                        currentConfig.thresholds = defaultThresholds;
                        loadConfiguration();
                        if (window.notify) window.notify.info('Seuils r√©initialis√©s', 'Valeurs par d√©faut restaur√©es.');
                    }
                });
            });

            ['warning-matieres', 'warning-bouteilles'].forEach(id => {
                document.getElementById(id)?.addEventListener('input', updateThresholdInfo);
            });
        }

        function setupNotifications() {
            document.getElementById('saveNotifications')?.addEventListener('click', function() {
                const newNotifications = {
                    duration: parseInt(document.getElementById('notification-duration')?.value || 4),
                    soundEnabled: document.getElementById('sound-notifications')?.checked || false
                };

                const saved = window.dbManager.updateConfiguration('notifications', newNotifications);
                
                if (saved) {
                    currentConfig.notifications = newNotifications;
                    if (window.notify) window.notify.success('Configuration sauvegard√©e', 'Param√®tres de notification mis √† jour.');
                } else {
                    if (window.notify) window.notify.error('Erreur', 'Impossible de sauvegarder la configuration.');
                }
            });

            document.getElementById('resetNotifications')?.addEventListener('click', function() {
                if (!window.notify) return;
                
                const confirmNotification = window.notify.warning('R√©initialiser les notifications', 'Remettre les valeurs par d√©faut ?', 10000);
                addConfirmationButtons(confirmNotification, () => {
                    const defaultNotifications = { duration: 4, soundEnabled: true };
                    const saved = window.dbManager.updateConfiguration('notifications', defaultNotifications);
                    
                    if (saved) {
                        currentConfig.notifications = defaultNotifications;
                        loadConfiguration();
                        if (window.notify) window.notify.info('Notifications r√©initialis√©es', 'Param√®tres par d√©faut restaur√©s.');
                    }
                });
            });
        }

        function setupSystem() {
            document.getElementById('saveSystem')?.addEventListener('click', function() {
                const newSystem = {
                    sessionTimeout: parseInt(document.getElementById('session-timeout')?.value || 60),
                    theme: document.getElementById('theme-mode')?.value || 'light'
                };

                const saved = window.dbManager.updateConfiguration('system', newSystem);
                
                if (saved) {
                    currentConfig.system = newSystem;
                    if (window.notify) window.notify.success('Configuration sauvegard√©e', 'Param√®tres syst√®me mis √† jour.');
                } else {
                    if (window.notify) window.notify.error('Erreur', 'Impossible de sauvegarder la configuration.');
                }
            });

            document.getElementById('resetSystem')?.addEventListener('click', function() {
                if (!window.notify) return;
                
                const confirmNotification = window.notify.warning('R√©initialiser le syst√®me', 'Remettre les valeurs par d√©faut ?', 10000);
                addConfirmationButtons(confirmNotification, () => {
                    const defaultSystem = { sessionTimeout: 60, theme: 'light' };
                    const saved = window.dbManager.updateConfiguration('system', defaultSystem);
                    
                    if (saved) {
                        currentConfig.system = defaultSystem;
                        loadConfiguration();
                        if (window.notify) window.notify.info('Syst√®me r√©initialis√©', 'Param√®tres par d√©faut restaur√©s.');
                    }
                });
            });
        }

        function setupLogout() {
            document.getElementById('logoutBtn')?.addEventListener('click', function(e) {
                e.preventDefault();
                
                if (!window.notify) return;
                
                const confirmNotification = window.notify.info('Confirmation de d√©connexion', '√ätes-vous s√ªr de vouloir vous d√©connecter ?', 10000);
                addConfirmationButtons(confirmNotification, () => {
                    if (window.notify) window.notify.info('D√©connexion en cours', 'Redirection vers l\'accueil...');
                    setTimeout(() => window.location.href = '../index.html', 1000);
                }, 'D√©connexion');
            });
        }

        // === CHARGEMENT DES DONN√âES ===
        async function loadAllData() {
            try {
                currentUsers = window.dbManager.getUsers();
                currentConfig = window.dbManager.getConfiguration();
                
                console.log('üë• Utilisateurs charg√©s:', Object.keys(currentUsers).length);
                console.log('‚öôÔ∏è Configuration charg√©e:', currentConfig);
                
                updateUsersTable();
                loadConfiguration();
                
            } catch (error) {
                console.error('‚ùå Erreur lors du chargement des donn√©es:', error);
                if (window.notify) {
                    window.notify.error('Erreur', 'Impossible de charger les donn√©es de configuration.');
                }
            }
        }

        // === INITIALISATION ===
        function initConfigPage() {
            console.log('üîÑ Initialisation de la page de configuration...');
            
            if (!window.dbManager || !window.dbManager.waitForReady) {
                console.log('‚è≥ En attente du DatabaseManager...');
                setTimeout(initConfigPage, 100);
                return;
            }
            
            console.log('üìä DatabaseManager trouv√©, attente de l\'initialisation...');
            
            window.dbManager.waitForReady().then(async () => {
                console.log('‚úÖ DatabaseManager pr√™t, chargement des donn√©es...');
                
                await loadAllData();
                
                console.log('üîß Initialisation des gestionnaires d\'√©v√©nements...');
                
                try {
                    setupUserManagement();
                    setupThresholds();
                    setupNotifications();
                    setupSystem();
                    setupLogout();
                    
                    console.log('‚úÖ Page Configuration charg√©e avec donn√©es DB !');
                } catch (setupError) {
                    console.error('‚ùå Erreur lors de l\'initialisation des gestionnaires:', setupError);
                    if (window.notify) {
                        window.notify.error('Erreur', 'Probl√®me lors de l\'initialisation de l\'interface.');
                    }
                }
                
            }).catch(error => {
                console.error('‚ùå Erreur lors de l\'initialisation:', error);
                if (window.notify) {
                    window.notify.error('Erreur', 'Impossible de charger la configuration.');
                }
            });
        }

        // D√©marrer l'initialisation
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ DOM charg√©, d√©marrage de l\'initialisation...');
            initConfigPage();
        });
    </script>
</body>
</html>
