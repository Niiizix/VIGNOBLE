<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documents - Marlowe Vineyard Intranet</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
    <!-- PDF-lib pour modifier les PDFs existants -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <style>
        /* Styles pour cacher complètement les sections sans permissions */
        .hidden-section {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav-container">
            <a href="../index.html" class="logo">
                <i class="fas fa-shield-alt"></i>
                Marlowe Intranet
            </a>
            <ul class="nav-menu">
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="inventaire.html">Inventaire</a></li>
                <li><a href="commandes.html">Commandes</a></li>
                <li><a href="documents.html" class="active">Documents</a></li>
                <li><a href="configuration.html">Configuration</a></li>
                <li><a href="../index.html" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Déconnexion
                </a></li>
            </ul>
        </nav>
    </header>

    <!-- Hero Section -->
    <section class="hero hero-intranet">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        
        <div class="hero-content">
            <h1>Génération de Documents</h1>
            <p class="subtitle">Création automatisée de documents</p>
            <p>Générez rapidement vos devis, factures et autres documents commerciaux avec calculs automatiques.</p>
        </div>
    </section>

    <!-- Modal Devis -->
    <div id="devisModal" class="modal-devis">
        <div class="modal-devis-content">
            <div class="modal-devis-header">
                <h3><i class="fas fa-file-invoice-dollar"></i> Créer un Devis</h3>
                <span class="modal-close" id="closeDevisModal">&times;</span>
            </div>
            <div class="modal-devis-body">
                
                <!-- Informations Client -->
                <div class="devis-section">
                    <h4><i class="fas fa-user"></i> Informations Client</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nom complet *</label>
                            <input type="text" id="client-nom" class="form-input" required placeholder="Nom et prénom du client">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" id="client-email" class="form-input" placeholder="email@exemple.com">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Adresse complète *</label>
                        <textarea id="client-adresse" class="form-textarea" rows="3" required placeholder="Adresse, code postal, ville"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Téléphone</label>
                            <input type="tel" id="client-telephone" class="form-input" placeholder="+33 1 23 45 67 89">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Numéro de devis</label>
                            <input type="text" id="numero-devis" class="form-input" readonly>
                        </div>
                    </div>
                </div>

                <!-- Sélection des Produits -->
                <div class="devis-section">
                    <div class="section-header">
                        <h4><i class="fas fa-wine-bottle"></i> Sélection des Produits</h4>
                        <button type="button" class="btn-add-product" id="addProductBtn">
                            <i class="fas fa-plus"></i> Ajouter
                        </button>
                    </div>
                    <div id="products-container">
                        <!-- Les lignes de produits seront ajoutées ici -->
                    </div>
                </div>

                <!-- Totaux -->
                <div class="devis-section">
                    <h4><i class="fas fa-calculator"></i> Récapitulatif</h4>
                    <div class="totals-container">
                        <div class="total-line">
                            <span class="total-label">Sous-total HT :</span>
                            <span class="total-value" id="sous-total">0.00$</span>
                        </div>
                        <div class="total-line">
                            <span class="total-label">TVA (21%) :</span>
                            <span class="total-value" id="tva-montant">0.00$</span>
                        </div>
                        <div class="total-line total-final">
                            <span class="total-label">Total TTC :</span>
                            <span class="total-value" id="total-final">0.00$</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-devis-footer">
                <button type="button" class="cta-button btn-secondary" id="cancelDevis">
                    <i class="fas fa-times"></i> Annuler
                </button>
                <button type="button" class="cta-button btn-success" id="generateDevisComplete">
                    <i class="fas fa-check"></i> Confirmer le Devis
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Facture -->
    <div id="factureModal" class="modal-devis">
        <div class="modal-devis-content">
            <div class="modal-devis-header">
                <h3><i class="fas fa-receipt"></i> Créer une Facture</h3>
                <span class="modal-close" id="closeFactureModal">&times;</span>
            </div>
            <div class="modal-devis-body">
                
                <!-- Informations Client -->
                <div class="devis-section">
                    <h4><i class="fas fa-user"></i> Informations Client</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nom complet *</label>
                            <input type="text" id="facture-client-nom" class="form-input" required placeholder="Nom et prénom du client">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" id="facture-client-email" class="form-input" placeholder="email@exemple.com">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Adresse complète *</label>
                        <textarea id="facture-client-adresse" class="form-textarea" rows="3" required placeholder="Adresse, code postal, ville"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Téléphone</label>
                            <input type="tel" id="facture-client-telephone" class="form-input" placeholder="+33 1 23 45 67 89">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Numéro de facture</label>
                            <input type="text" id="numero-facture" class="form-input" readonly>
                        </div>
                    </div>
                </div>
    
                <!-- Sélection des Produits -->
                <div class="devis-section">
                    <div class="section-header">
                        <h4><i class="fas fa-wine-bottle"></i> Sélection des Produits</h4>
                        <button type="button" class="btn-add-product" id="addFactureProductBtn">
                            <i class="fas fa-plus"></i> Ajouter
                        </button>
                    </div>
                    <div id="facture-products-container">
                        <!-- Les lignes de produits seront ajoutées ici -->
                    </div>
                </div>
    
                <!-- Totaux -->
                <div class="devis-section">
                    <h4><i class="fas fa-calculator"></i> Récapitulatif</h4>
                    <div class="totals-container">
                        <div class="total-line">
                            <span class="total-label">Sous-total HT :</span>
                            <span class="total-value" id="facture-sous-total">0.00$</span>
                        </div>
                        <div class="total-line">
                            <span class="total-label">TVA (21%) :</span>
                            <span class="total-value" id="facture-tva-montant">0.00$</span>
                        </div>
                        <div class="total-line total-final">
                            <span class="total-label">Total TTC :</span>
                            <span class="total-value" id="facture-total-final">0.00$</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-devis-footer">
                <button type="button" class="cta-button btn-secondary" id="cancelFacture">
                    <i class="fas fa-times"></i> Annuler
                </button>
                <button type="button" class="cta-button btn-success" id="generateFactureComplete">
                    <i class="fas fa-check"></i> Confirmer la Facture
                </button>
            </div>
        </div>
    </div>

    <!-- Documents Section -->
    <section class="documents-section">
        <div class="documents-container">
            
            <!-- Documents Clients -->
            <div class="document-category">
                <div class="category-header">
                    <h2><i class="fas fa-user-tie"></i> Documents Clients</h2>
                    <p>Créez tous vos documents commerciaux destinés aux clients</p>

                    <div id="templateStatus" style="margin-top: 15px; text-align: center;"></div>
                </div>
                
                <div class="documents-grid">
                    <div class="document-card">
                        <div class="document-icon">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                        <h3>Devis Client</h3>
                        <p>Générez un devis personnalisé avec calculs automatiques des totaux HT/TTC et envoi Discord</p>
                        <button class="cta-button btn-success document-btn" data-document="devis">
                            <i class="fas fa-plus"></i> Créer un Devis
                        </button>
                    </div>

                    <div class="document-card">
                        <div class="document-icon">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <h3>Facture</h3>
                        <p>Émettez une facture après commande avec détail des produits et montants</p>
                        <button class="cta-button btn-primary document-btn" data-document="facture">
                            <i class="fas fa-plus"></i> Créer une Facture
                        </button>
                    </div>

                    <div class="document-card">
                        <div class="document-icon">
                            <i class="fas fa-truck"></i>
                        </div>
                        <h3>Bon de Livraison</h3>
                        <p>Préparez les bons de livraison pour les expéditions et livraisons clients</p>
                        <button class="cta-button btn-info document-btn" data-document="livraison">
                            <i class="fas fa-plus"></i> Créer un Bon
                        </button>
                    </div>

                    <div class="document-card">
                        <div class="document-icon">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <h3>Contrat de Visite</h3>
                        <p>Formalisez les réservations de visites avec conditions et tarification</p>
                        <button class="cta-button btn-purple document-btn" data-document="visite">
                            <i class="fas fa-plus"></i> Créer un Contrat
                        </button>
                    </div>
                </div>
            </div>

            <!-- Documents Internes (avec contrôle d'accès) -->
            <div class="document-category" id="internal-documents-section">
                <div class="category-header">
                    <h2><i class="fas fa-building"></i> Documents Internes</h2>
                    <p>Gérez vos documents internes et rapports d'activité</p>
                </div>
                
                <div class="documents-grid">
                    <div class="document-card">
                        <div class="document-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <h3>Rapport d'Inventaire</h3>
                        <p>Générez un rapport détaillé de l'état actuel des stocks et valeurs</p>
                        <button class="cta-button btn-warning document-btn" data-document="inventaire">
                            <i class="fas fa-plus"></i> Générer le Rapport
                        </button>
                    </div>

                    <div class="document-card">
                        <div class="document-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <h3>Rapport de Ventes</h3>
                        <p>Synthèse des ventes par période avec analyse des performances</p>
                        <button class="cta-button btn-success document-btn" data-document="ventes">
                            <i class="fas fa-plus"></i> Générer le Rapport
                        </button>
                    </div>

                    <div class="document-card">
                        <div class="document-icon">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <h3>Bon de Commande</h3>
                        <p>Commandes fournisseurs pour réapprovisionnement en matières premières</p>
                        <button class="cta-button btn-info document-btn" data-document="commande">
                            <i class="fas fa-plus"></i> Créer une Commande
                        </button>
                    </div>

                    <div class="document-card">
                        <div class="document-icon">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <h3>Fiche de Production</h3>
                        <p>Documenter les étapes de production et qualité des cuvées</p>
                        <button class="cta-button btn-purple document-btn" data-document="production">
                            <i class="fas fa-plus"></i> Créer une Fiche
                        </button>
                    </div>
                </div>
            </div>

            <!-- Statistiques -->
            <div class="documents-stats">
                <div class="stats-header">
                    <h3><i class="fas fa-chart-pie"></i> Statistiques Documents</h3>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number">47</div>
                        <div class="stat-label">Devis ce mois</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">23</div>
                        <div class="stat-label">Factures émises</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">15</div>
                        <div class="stat-label">Livraisons</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">8</div>
                        <div class="stat-label">Rapports générés</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2025 Marlowe Vineyard - Intranet Privé | Accès Restreint</p>
    </footer>

    <script src="../script.js"></script>
    <script>
        // === VARIABLES GLOBALES ===
        let currentUser = null;
        let hasInternalAccess = false;

        // === VÉRIFICATION DES PERMISSIONS ===
        function getCurrentUser() {
            // Récupérer l'utilisateur connecté (à adapter selon votre système de session)
            // Pour l'exemple, on utilise un utilisateur par défaut
            currentUser = {
                username: 'admin',
                fullname: 'STAFF',
                grade: 'staff',
                permissions: ['dashboard', 'inventory', 'documents', 'documents_internal', 'config', 'reports', 'users']
            };
            
            // Vérifier si l'utilisateur a accès aux documents internes
            hasInternalAccess = currentUser.permissions.includes('documents_internal');
            
            console.log('👤 Utilisateur connecté:', currentUser.username);
            console.log('🔐 Accès documents internes:', hasInternalAccess ? 'OUI' : 'NON');
            
            return currentUser;
        }

        function checkInternalDocumentsAccess() {
            const internalSection = document.getElementById('internal-documents-section');
            
            if (!hasInternalAccess) {
                console.log('🚫 Accès refusé aux documents internes - Section cachée');
                
                // Cacher complètement la section
                internalSection.style.display = 'none';
                
                console.log('📋 Section documents internes masquée pour cet utilisateur');
            } else {
                console.log('✅ Accès autorisé aux documents internes - Section visible');
                
                // S'assurer que la section est visible
                internalSection.style.display = 'block';
            }
        }

        // === CONFIGURATION DISCORD ===
        const DISCORD_WEBHOOK_URL = 'https://l.webhook.party/hook/p8GEvGjZOXrEAnlh9Czg9Tc0iTQBwifuEMuxxUSXDviB6TigfRf2602NP8WKvfbOKbznpmCc84gFdsh3ReH%2BnwfMPy%2FQuxLaSOKoEhONeF2Sa%2BdlaQeZIF8HnyhTdm%2F139Gp1ZQNINg2u5wL4iv3Gnf4vhyNTH6f2v%2BeDX4gF2wk4Ggtz1JckA7wL2zzdEzp7kngu9sT97mMpEQ7hSGib3GfUgQ3XE4yHljVjprjK2vKD1WrJrbkCigxZhM5evlSs0rWFg4vxjo9ytsVdHnbv%2BXF%2FcNb%2BY9c%2Foyj0WNqRrV7WDawmXYGA7%2B1iwKAMhPxDJvGwfytR64FeOoSQdEEfHlk4wKErY6S4Cdvq3FHsDpfrF2Kr3vByaujn%2BhjOUxk51U%2Bf10knUI%3D/O39Ms6oV6RQnZDds';
        const DISCORD_USERNAME = 'Marlowe Vineyard';

        // === TEMPLATE PDF ===
        let templatePDF = null;
        let templateFacturePDF = null;

        // === SYSTÈME DE PRODUITS ET MODALS (code existant) ===
        const produits = {
            'marlowe-rouge': { nom: 'Marlowe Rouge Reserve', prix: 450 },
            'marlowe-blanc': { nom: 'Marlowe Blanc Premium', prix: 380 },
            'marlowe-prestige': { nom: 'Marlowe Prestige', prix: 850 },
            'marlowe-rose': { nom: 'Marlowe Rose', prix: 320 },
            'marlowe-vintage': { nom: 'Marlowe Vintage', prix: 1200 },
            'coffret-degustation': { nom: 'Coffret Degustation', prix: 1800 }
        };

        let productCounter = 0;
        let devisData = { client: {}, produits: [], totaux: { sousTotal: 0, tva: 0, total: 0 } };
        let factureProductCounter = 0;
        let factureData = { client: {}, produits: [], totaux: { sousTotal: 0, tva: 0, total: 0 } };

        // === FONCTION NETTOYAGE SIMPLE ET EFFICACE ===
        function cleanTextForPDF(text) {
            if (!text) return '';
            
            return String(text)
                .replace(/[àáâäã]/gi, 'a')
                .replace(/[èéêë]/gi, 'e')
                .replace(/[ìíîï]/gi, 'i')
                .replace(/[òóôöõ]/gi, 'o')
                .replace(/[ùúûü]/gi, 'u')
                .replace(/[ç]/gi, 'c')
                .replace(/[ñ]/gi, 'n')
                .replace(/[–—]/g, '-')
                .replace(/['']/g, "'")
                .replace(/[""]/g, '"')
                .replace(/[^\x20-\x7E\n\r\t]/g, '')
                .replace(/\s+/g, ' ')
                .trim();
        }

        // === CHARGEMENT TEMPLATES ===
        async function tryLoadDefaultTemplate() {
            try {
                showTemplateStatus('🔄 Chargement du template...', 'info');
                
                const response = await fetch('../assets/template-devis.pdf');
                if (response.ok) {
                    const blob = await response.blob();
                    const arrayBuffer = await blob.arrayBuffer();
                    templatePDF = await PDFLib.PDFDocument.load(arrayBuffer);
                    
                    showTemplateStatus('✅ Template chargé avec succès', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showTemplateStatus('❌ Template non trouvé', 'error');
            }
        }

        async function tryLoadFactureTemplate() {
            try {
                showTemplateStatus('🔄 Chargement du template facture...', 'info');
                
                const response = await fetch('../assets/template-factures.pdf');
                if (response.ok) {
                    const blob = await response.blob();
                    const arrayBuffer = await blob.arrayBuffer();
                    templateFacturePDF = await PDFLib.PDFDocument.load(arrayBuffer);
                    
                    showTemplateStatus('✅ Template facture chargé avec succès', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showTemplateStatus('❌ Template facture non trouvé', 'error');
            }
        }

        function showTemplateStatus(message, type) {
            const statusDiv = document.getElementById('templateStatus');
            const colors = {
                success: '#d4edda; color: #155724',
                error: '#f8d7da; color: #721c24',
                info: '#cce7ff; color: #004085'
            };
            
            statusDiv.innerHTML = `<div style="background: ${colors[type]}; padding: 10px; border-radius: 5px; font-size: 14px;">${message}</div>`;
        }

        // === GESTION DES BOUTONS AVEC PERMISSIONS ===
        function handleDocumentButtonClick(documentType) {
            // Les documents internes ne sont plus accessibles ici car la section est cachée
            // Traitement normal des documents clients uniquement
            if (documentType === 'devis') {
                if (!templatePDF) {
                    if (window.notify) window.notify.warning('Template manquant', 'Le template PDF n\'est pas encore chargé.');
                    return;
                }
                openDevisForm();
            } else if (documentType === 'facture') {
                if (!templateFacturePDF) {
                    if (window.notify) window.notify.warning('Template manquant', 'Le template PDF facture n\'est pas encore chargé.');
                    return;
                }
                openFactureForm();
            } else {
                if (window.notify) {
                    window.notify.info('En préparation', 'Cette fonctionnalité sera bientôt disponible !');
                }
            }
        }

        // === FONCTIONS MODALS DEVIS/FACTURE (version simplifiée) ===
        function openDevisForm() {
            document.getElementById('devisModal').style.display = 'flex';
            resetDevisForm();
            generateDevisNumber();
            addProductLine();
        }

        function closeDevisModal() {
            document.getElementById('devisModal').style.display = 'none';
        }

        function openFactureForm() {
            document.getElementById('factureModal').style.display = 'flex';
            resetFactureForm();
            generateFactureNumber();
            addFactureProductLine();
        }
        
        function closeFactureModal() {
            document.getElementById('factureModal').style.display = 'none';
        }

        function resetDevisForm() {
            document.getElementById('client-nom').value = '';
            document.getElementById('client-email').value = '';
            document.getElementById('client-adresse').value = '';
            document.getElementById('client-telephone').value = '';
            document.getElementById('products-container').innerHTML = '';
            productCounter = 0;
            updateTotals();
        }

        function resetFactureForm() {
            document.getElementById('facture-client-nom').value = '';
            document.getElementById('facture-client-email').value = '';
            document.getElementById('facture-client-adresse').value = '';
            document.getElementById('facture-client-telephone').value = '';
            document.getElementById('facture-products-container').innerHTML = '';
            factureProductCounter = 0;
            updateFactureTotals();
        }

        function generateDevisNumber() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            
            document.getElementById('numero-devis').value = `DV${year}${month}${day}-${random}`;
        }

        function generateFactureNumber() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            
            document.getElementById('numero-facture').value = `FA${year}${month}${day}-${random}`;
        }

        // === FONCTIONS PRODUITS (version simplifiée) ===
        function addProductLine() {
            productCounter++;
            const container = document.getElementById('products-container');
            
            const productLine = document.createElement('div');
            productLine.className = 'product-line';
            productLine.dataset.id = productCounter;
            
            let optionsHTML = '<option value="">Sélectionnez un produit</option>';
            Object.entries(produits).forEach(([key, prod]) => {
                optionsHTML += `<option value="${key}">${prod.nom} - ${prod.prix}</option>`;
            });
            
            productLine.innerHTML = `
                <div class="product-line-header">
                    <span class="product-number">Produit ${productCounter}</span>
                    ${productCounter > 1 ? `<button type="button" class="btn-remove-product" onclick="removeProductLine(${productCounter})"><i class="fas fa-trash"></i></button>` : ''}
                </div>
                <div class="form-row">
                    <div class="form-group flex-2">
                        <label class="form-label">Produit</label>
                        <select class="form-select product-select" data-id="${productCounter}" onchange="updateProductPrice(${productCounter})">
                            ${optionsHTML}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Prix unitaire</label>
                        <input type="text" class="form-input product-price" data-id="${productCounter}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quantité</label>
                        <input type="number" class="form-input product-quantity" data-id="${productCounter}" min="1" value="1" onchange="updateLineTotal(${productCounter})">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Total HT</label>
                        <input type="text" class="form-input product-total" data-id="${productCounter}" readonly>
                    </div>
                </div>
            `;
            
            container.appendChild(productLine);
        }

        function addFactureProductLine() {
            factureProductCounter++;
            const container = document.getElementById('facture-products-container');
            
            const productLine = document.createElement('div');
            productLine.className = 'product-line';
            productLine.dataset.id = factureProductCounter;
            
            let optionsHTML = '<option value="">Sélectionnez un produit</option>';
            Object.entries(produits).forEach(([key, prod]) => {
                optionsHTML += `<option value="${key}">${prod.nom} - ${prod.prix}</option>`;
            });
            
            productLine.innerHTML = `
                <div class="product-line-header">
                    <span class="product-number">Produit ${factureProductCounter}</span>
                    ${factureProductCounter > 1 ? `<button type="button" class="btn-remove-product" onclick="removeFactureProductLine(${factureProductCounter})"><i class="fas fa-trash"></i></button>` : ''}
                </div>
                <div class="form-row">
                    <div class="form-group flex-2">
                        <label class="form-label">Produit</label>
                        <select class="form-select product-select" data-id="${factureProductCounter}" onchange="updateFactureProductPrice(${factureProductCounter})">
                            ${optionsHTML}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Prix unitaire</label>
                        <input type="text" class="form-input product-price" data-id="${factureProductCounter}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quantité</label>
                        <input type="number" class="form-input product-quantity" data-id="${factureProductCounter}" min="1" value="1" onchange="updateFactureLineTotal(${factureProductCounter})">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Total HT</label>
                        <input type="text" class="form-input product-total" data-id="${factureProductCounter}" readonly>
                    </div>
                </div>
            `;
            
            container.appendChild(productLine);
        }

        // === FONCTIONS UTILITAIRES ===
        function removeProductLine(id) {
            const line = document.querySelector(`[data-id="${id}"]`);
            if (line) {
                line.remove();
                updateTotals();
            }
        }

        function removeFactureProductLine(id) {
            const line = document.querySelector(`#facture-products-container [data-id="${id}"]`);
            if (line) {
                line.remove();
                updateFactureTotals();
            }
        }

        function updateProductPrice(id) {
            const select = document.querySelector(`select[data-id="${id}"]`);
            const priceInput = document.querySelector(`input.product-price[data-id="${id}"]`);
            
            if (select.value) {
                const prix = produits[select.value].prix;
                priceInput.value = `${prix}.00`;
                updateLineTotal(id);
            } else {
                priceInput.value = '';
                updateLineTotal(id);
            }
        }

        function updateFactureProductPrice(id) {
            const select = document.querySelector(`#facture-products-container select[data-id="${id}"]`);
            const priceInput = document.querySelector(`#facture-products-container input.product-price[data-id="${id}"]`);
            
            if (select.value) {
                const prix = produits[select.value].prix;
                priceInput.value = `${prix}.00`;
                updateFactureLineTotal(id);
            } else {
                priceInput.value = '';
                updateFactureLineTotal(id);
            }
        }

        function updateLineTotal(id) {
            const select = document.querySelector(`select[data-id="${id}"]`);
            const quantityInput = document.querySelector(`input.product-quantity[data-id="${id}"]`);
            const totalInput = document.querySelector(`input.product-total[data-id="${id}"]`);
            
            if (select.value && quantityInput.value) {
                const prix = produits[select.value].prix;
                const quantity = parseInt(quantityInput.value) || 0;
                const total = prix * quantity;
                
                totalInput.value = `${total.toLocaleString('en-US')}.00`;
            } else {
                totalInput.value = '';
            }
            
            updateTotals();
        }

        function updateFactureLineTotal(id) {
            const select = document.querySelector(`#facture-products-container select[data-id="${id}"]`);
            const quantityInput = document.querySelector(`#facture-products-container input.product-quantity[data-id="${id}"]`);
            const totalInput = document.querySelector(`#facture-products-container input.product-total[data-id="${id}"]`);
            
            if (select.value && quantityInput.value) {
                const prix = produits[select.value].prix;
                const quantity = parseInt(quantityInput.value) || 0;
                const total = prix * quantity;
                
                totalInput.value = `${total.toLocaleString('en-US')}.00`;
            } else {
                totalInput.value = '';
            }
            
            updateFactureTotals();
        }

        function updateTotals() {
            let sousTotal = 0;
            
            document.querySelectorAll('.product-line').forEach(line => {
                const id = line.dataset.id;
                const select = document.querySelector(`select[data-id="${id}"]`);
                const quantityInput = document.querySelector(`input.product-quantity[data-id="${id}"]`);
                
                if (select && select.value && quantityInput && quantityInput.value) {
                    const prix = produits[select.value].prix;
                    const quantity = parseInt(quantityInput.value) || 0;
                    sousTotal += prix * quantity;
                }
            });
            
            const tva = sousTotal * 0.21;
            const total = sousTotal + tva;
            
            document.getElementById('sous-total').textContent = `${sousTotal.toLocaleString('en-US')}.00`;
            document.getElementById('tva-montant').textContent = `${tva.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('total-final').textContent = `${total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            
            devisData.totaux = { sousTotal, tva, total };
        }

        function updateFactureTotals() {
            let sousTotal = 0;
            
            document.querySelectorAll('#facture-products-container .product-line').forEach(line => {
                const id = line.dataset.id;
                const select = document.querySelector(`#facture-products-container select[data-id="${id}"]`);
                const quantityInput = document.querySelector(`#facture-products-container input.product-quantity[data-id="${id}"]`);
                
                if (select && select.value && quantityInput && quantityInput.value) {
                    const prix = produits[select.value].prix;
                    const quantity = parseInt(quantityInput.value) || 0;
                    sousTotal += prix * quantity;
                }
            });
            
            const tva = sousTotal * 0.21;
            const total = sousTotal + tva;
            
            document.getElementById('facture-sous-total').textContent = `${sousTotal.toLocaleString('en-US')}.00`;
            document.getElementById('facture-tva-montant').textContent = `${tva.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('facture-total-final').textContent = `${total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            
            factureData.totaux = { sousTotal, tva, total };
        }

        // === INITIALISATION ===
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initialisation Documents avec contrôle d\'accès...');
            
            // Récupérer l'utilisateur actuel et vérifier les permissions
            getCurrentUser();
            checkInternalDocumentsAccess();
            
            // Charger les templates automatiquement
            tryLoadDefaultTemplate();
            tryLoadFactureTemplate();

            // Gestion des boutons avec vérification des permissions
            document.querySelectorAll('.document-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const documentType = this.dataset.document;
                    handleDocumentButtonClick(documentType);
                });
            });

            // Gestion des modals
            document.getElementById('closeDevisModal').onclick = closeDevisModal;
            document.getElementById('cancelDevis').onclick = closeDevisModal;
            document.getElementById('addProductBtn').onclick = addProductLine;
            
            document.getElementById('closeFactureModal').onclick = closeFactureModal;
            document.getElementById('cancelFacture').onclick = closeFactureModal;
            document.getElementById('addFactureProductBtn').onclick = addFactureProductLine;

            // Gestion déconnexion
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                if (confirm('Êtes-vous sûr de vouloir vous déconnecter ?')) {
                    window.location.href = '../index.html';
                }
            });

            console.log('✅ Documents initialisés avec succès !');
        });
    </script>
</body>
</html>
