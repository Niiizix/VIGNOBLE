async function tryLoadDefaultTemplate() {
            // V√©rifier si on est en mode file:// (probl√®me CORS)
            if (window.location.protocol === 'file:') {
                showTemplateStatus('‚ö†Ô∏è Mode fichier local d√©tect√©. Chargement manuel requis.', 'info');
                console.log('=== PROBL√àME CORS D√âTECT√â ===');
                console.log('Vous ouvrez le fichier HTML directement (file://)');
                console.log('Les navigateurs bloquent fetch() pour des raisons de s√©curit√©');
                console.log('SOLUTIONS:');
                console.log('1. Utilisez un serveur local (recommand√©)');
                console.log('2. Ou utilisez le chargement manuel ci-dessous');
                
                // Afficher l'interface de chargement manuel
                showManualUpload();
                return;
            }
            
            // Mode serveur HTTP - tenter le chargement automatique
            const possiblePaths = [
                '../assets/template-devis.pdf',    
                './assets/template-devis.pdf',     
                '/assets/template-devis.pdf',      
                'assets/template-devis.pdf'
            ];
            
            showTemplateStatus('üîÑ Recherche du template...', 'info');
            console.log('=== CHARGEMENT TEMPLATE (MODE SERVEUR) ===');
            
            for (let i = 0; i < possiblePaths.length; i++) {
                const path = possiblePaths[i];
                try {
                    console.log(`[${i+1}/${possiblePaths.length}] Test: ${path}`);
                    
                    const response = await fetch(path);
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        
                        if (blob.size > 0) {
                            await loadTemplateFromBlob(blob, 'template-devis.pdf');
                            showTemplateStatus(`‚úÖ Template charg√© depuis: ${path}`, 'success');
                            console.log(`‚úÖ SUCCESS! Template charg√© depuis: ${path}`);
                            return;
                        }
                    }
                } catch (error) {
                    console.log(`‚ùå Erreur avec ${path}:`, error.message);
                }
            }
            
            // Si aucun path n'a fonctionn√© en mode serveur
            showTemplateStatus('‚ùå Template non trouv√©. Utilisation du chargement manuel.', 'error');
            showManualUpload();
        }

        function showManualUpload() {
            // Cr√©er une interface de chargement manuel int√©gr√©e
            const templateStatus = document.getElementById('templateStatus');
            templateStatus.innerHTML = `
                <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border: 2px solid #ffc107; margin: 15px 0;">
                    <h4 style="color: #856404; margin-bottom: 15px;">
                        <i class="fas fa-upload"></i> Chargement manuel requis
                    </h4>
                    <p style="color: #856404; margin-bottom: 15px; font-size: 14px;">
                        Pour des raisons de s√©curit√©, veuillez s√©lectionner votre template PDF manuellement :
                    </p>
                    <input type="file" id="manualTemplateInput" accept=".pdf" style="margin-bottom: 10px;">
                    <br>
                    <small style="color: #6c757d;">
                        üìÅ S√©lectionnez: <strong>assets/template-devis.pdf</strong>
                    </small>
                </div>
            `;
            
            // Ajouter l'√©v√©nement pour le chargement manuel
            document.getElementById('manualTemplateInput').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file && file.type === 'application/pdf') {
                    try {
                        await loadTemplateFromBlob(file, file.name);
                        showTemplateStatus('‚úÖ Template charg√© manuellement avec succ√®s!', 'success');
                        console.log('‚úÖ Template charg√© manuellement');
                    } catch (error) {
                        showTemplateStatus('‚ùå Erreur lors du chargement: ' + error.message, 'error');
                    }
                } else {
                    showTemplateStatus('‚ùå Veuillez s√©lectionner un fichier<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documents - Marlowe Vineyard Intranet</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
    <!-- PDF-lib pour modifier les PDFs existants -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav-container">
            <a href="../index.html" class="logo">
                <i class="fas fa-shield-alt"></i>
                Marlowe Intranet
            </a>
            <ul class="nav-menu">
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="inventaire.html">Inventaire</a></li>
                <li><a href="#commandes">Commandes</a></li>
                <li><a href="documents.html" class="active">Documents</a></li>
                <li><a href="configuration.html">Configuration</a></li>
                <li><a href="#" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> D√©connexion
                </a></li>
            </ul>
        </nav>
    </header>

    <!-- Hero Section -->
    <section class="hero hero-intranet">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        
        <div class="hero-content">
            <h1>G√©n√©ration de Documents</h1>
            <p class="subtitle">Cr√©ation automatis√©e de documents</p>
            <p>G√©n√©rez rapidement vos devis, factures et autres documents commerciaux avec calculs automatiques.</p>
        </div>
    </section>

    <!-- Modal Configuration Discord -->
    <div id="discordConfigModal" class="modal-devis" style="display: none;">
        <div class="modal-devis-content" style="max-width: 600px;">
            <div class="modal-devis-header" style="background: #7289da;">
                <h3><i class="fab fa-discord"></i> Configuration Discord</h3>
                <span class="modal-close" onclick="closeDiscordConfig()">&times;</span>
            </div>
            <div class="modal-devis-body">
                <div class="devis-section">
                    <h4><i class="fas fa-cog"></i> Webhook Discord</h4>
                    <p>Configurez l'envoi automatique des devis sur votre serveur Discord :</p>
                    
                    <div class="form-group">
                        <label class="form-label">URL du Webhook Discord *</label>
                        <input type="url" id="webhookUrl" class="form-input" 
                               placeholder="https://discord.com/api/webhooks/YOUR_WEBHOOK_URL">
                        <small style="color: #6c757d;">Pour cr√©er un webhook : Param√®tres du serveur > Int√©grations > Webhooks > Nouveau Webhook</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Nom d'affichage (optionnel)</label>
                        <input type="text" id="discordUsername" class="form-input" 
                               value="Marlowe Vineyard" placeholder="Nom affich√© sur Discord">
                    </div>
                </div>
            </div>
            <div class="modal-devis-footer">
                <button type="button" class="cta-button btn-secondary" onclick="closeDiscordConfig()">Annuler</button>
                <button type="button" class="cta-button" style="background: #7289da;" onclick="testDiscordWebhook()">
                    <i class="fas fa-paper-plane"></i> Tester Webhook
                </button>
                <button type="button" class="cta-button btn-success" onclick="saveDiscordConfig()">
                    <i class="fas fa-save"></i> Sauvegarder
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Devis -->
    <div id="devisModal" class="modal-devis">
        <div class="modal-devis-content">
            <div class="modal-devis-header">
                <h3><i class="fas fa-file-invoice-dollar"></i> Cr√©er un Devis</h3>
                <span class="modal-close" id="closeDevisModal">&times;</span>
            </div>
            <div class="modal-devis-body">
                
                <!-- Informations Client -->
                <div class="devis-section">
                    <h4><i class="fas fa-user"></i> Informations Client</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nom complet *</label>
                            <input type="text" id="client-nom" class="form-input" required placeholder="Nom et pr√©nom du client">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" id="client-email" class="form-input" placeholder="email@exemple.com">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Adresse compl√®te *</label>
                        <textarea id="client-adresse" class="form-textarea" rows="3" required placeholder="Adresse, code postal, ville"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">T√©l√©phone</label>
                            <input type="tel" id="client-telephone" class="form-input" placeholder="+33 1 23 45 67 89">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Num√©ro de devis</label>
                            <input type="text" id="numero-devis" class="form-input" readonly>
                        </div>
                    </div>
                </div>

                <!-- S√©lection des Produits -->
                <div class="devis-section">
                    <div class="section-header">
                        <h4><i class="fas fa-wine-bottle"></i> S√©lection des Produits</h4>
                        <button type="button" class="btn-add-product" id="addProductBtn">
                            <i class="fas fa-plus"></i> Ajouter
                        </button>
                    </div>
                    <div id="products-container">
                        <!-- Les lignes de produits seront ajout√©es ici -->
                    </div>
                </div>

                <!-- Totaux -->
                <div class="devis-section">
                    <h4><i class="fas fa-calculator"></i> R√©capitulatif</h4>
                    <div class="totals-container">
                        <div class="total-line">
                            <span class="total-label">Sous-total HT :</span>
                            <span class="total-value" id="sous-total">0,00 ‚Ç¨</span>
                        </div>
                        <div class="total-line">
                            <span class="total-label">TVA (21%) :</span>
                            <span class="total-value" id="tva-montant">0,00 ‚Ç¨</span>
                        </div>
                        <div class="total-line total-final">
                            <span class="total-label">Total TTC :</span>
                            <span class="total-value" id="total-final">0,00 ‚Ç¨</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-devis-footer">
                <button type="button" class="cta-button btn-secondary" id="cancelDevis">Annuler</button>
                <button type="button" class="cta-button btn-info" id="previewDevis">
                    <i class="fas fa-eye"></i> Pr√©visualiser
                </button>
                <button type="button" class="cta-button btn-success" id="generateDevis">
                    <i class="fas fa-file-pdf"></i> G√©n√©rer PDF
                </button>
                <button type="button" class="cta-button" style="background: #7289da;" id="generateAndSendDevis">
                    <i class="fab fa-discord"></i> PDF + Discord
                </button>
            </div>
        </div>
    </div>

    <!-- Documents Section -->
    <section class="documents-section">
        <div class="documents-container">
            
            <!-- Documents Clients -->
            <div class="document-category">
                <div class="category-header">
                    <h2><i class="fas fa-user-tie"></i> Documents Clients</h2>
                    <p>Cr√©ez tous vos documents commerciaux destin√©s aux clients</p>
                    <button class="cta-button" style="background: #7289da; margin-top: 10px;" onclick="openDiscordConfig()">
                        <i class="fab fa-discord"></i> Configurer Discord
                    </button>
                    <div id="templateStatus" style="margin-top: 15px; text-align: center;"></div>
                </div>
                
                <div class="documents-grid">
                    <div class="document-card">
                        <div class="document-icon">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                        <h3>Devis Client</h3>
                        <p>G√©n√©rez un devis personnalis√© avec calculs automatiques des totaux HT/TTC et envoi Discord</p>
                        <button class="cta-button btn-success document-btn" data-document="devis">
                            <i class="fas fa-plus"></i> Cr√©er un Devis
                        </button>
                    </div>

                    <div class="document-card">
                        <div class="document-icon">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <h3>Facture</h3>
                        <p>√âmettez une facture apr√®s commande avec d√©tail des produits et montants</p>
                        <button class="cta-button btn-primary document-btn" data-document="facture">
                            <i class="fas fa-plus"></i> Cr√©er une Facture
                        </button>
                    </div>

                    <div class="document-card">
                        <div class="document-icon">
                            <i class="fas fa-truck"></i>
                        </div>
                        <h3>Bon de Livraison</h3>
                        <p>Pr√©parez les bons de livraison pour les exp√©ditions et livraisons clients</p>
                        <button class="cta-button btn-info document-btn" data-document="livraison">
                            <i class="fas fa-plus"></i> Cr√©er un Bon
                        </button>
                    </div>

                    <div class="document-card">
                        <div class="document-icon">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <h3>Contrat de Visite</h3>
                        <p>Formalisez les r√©servations de visites avec conditions et tarification</p>
                        <button class="cta-button btn-purple document-btn" data-document="visite">
                            <i class="fas fa-plus"></i> Cr√©er un Contrat
                        </button>
                    </div>
                </div>
            </div>

            <!-- Documents Internes -->
            <div class="document-category">
                <div class="category-header">
                    <h2><i class="fas fa-building"></i> Documents Internes</h2>
                    <p>G√©rez vos documents internes et rapports d'activit√©</p>
                </div>
                
                <div class="documents-grid">
                    <div class="document-card">
                        <div class="document-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <h3>Rapport d'Inventaire</h3>
                        <p>G√©n√©rez un rapport d√©taill√© de l'√©tat actuel des stocks et valeurs</p>
                        <button class="cta-button btn-warning document-btn" data-document="inventaire">
                            <i class="fas fa-plus"></i> G√©n√©rer le Rapport
                        </button>
                    </div>

                    <div class="document-card">
                        <div class="document-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <h3>Rapport de Ventes</h3>
                        <p>Synth√®se des ventes par p√©riode avec analyse des performances</p>
                        <button class="cta-button btn-success document-btn" data-document="ventes">
                            <i class="fas fa-plus"></i> G√©n√©rer le Rapport
                        </button>
                    </div>

                    <div class="document-card">
                        <div class="document-icon">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <h3>Bon de Commande</h3>
                        <p>Commandes fournisseurs pour r√©approvisionnement en mati√®res premi√®res</p>
                        <button class="cta-button btn-info document-btn" data-document="commande">
                            <i class="fas fa-plus"></i> Cr√©er une Commande
                        </button>
                    </div>

                    <div class="document-card">
                        <div class="document-icon">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <h3>Fiche de Production</h3>
                        <p>Documenter les √©tapes de production et qualit√© des cuv√©es</p>
                        <button class="cta-button btn-purple document-btn" data-document="production">
                            <i class="fas fa-plus"></i> Cr√©er une Fiche
                        </button>
                    </div>
                </div>
            </div>

            <!-- Statistiques -->
            <div class="documents-stats">
                <div class="stats-header">
                    <h3><i class="fas fa-chart-pie"></i> Statistiques Documents</h3>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number">47</div>
                        <div class="stat-label">Devis ce mois</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">23</div>
                        <div class="stat-label">Factures √©mises</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">15</div>
                        <div class="stat-label">Livraisons</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">8</div>
                        <div class="stat-label">Rapports g√©n√©r√©s</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2025 Marlowe Vineyard - Intranet Priv√© | Acc√®s Restreint</p>
    </footer>

    <script src="../script.js"></script>
    <script>
        // === CONFIGURATION DISCORD ===
        let discordConfig = {
            webhookUrl: localStorage.getItem('marlowe_webhook_url') || '',
            username: localStorage.getItem('marlowe_discord_username') || 'Marlowe Vineyard'
        };

        // === FONCTION NETTOYAGE CARACT√àRES ULTRA-AGRESSIVE ===
        function cleanTextForPDF(text) {
            if (!text) return '';
            
            // Conversion ultra-agressive vers ASCII pur
            let cleaned = text
                .toString() // S'assurer que c'est une string
                .normalize('NFD') // D√©composer les accents
                .replace(/[\u0300-\u036f]/g, '') // Supprimer tous les accents
                
                // Remplacements de caract√®res probl√©matiques
                .replace(/[√†√°√¢√£√§√•ƒÅ]/gi, 'a')
                .replace(/[√®√©√™√´ƒì]/gi, 'e')
                .replace(/[√¨√≠√Æ√Øƒ´]/gi, 'i')
                .replace(/[√≤√≥√¥√µ√∂√∏≈ç]/gi, 'o')
                .replace(/[√π√∫√ª√º≈´]/gi, 'u')
                .replace(/[√±]/gi, 'n')
                .replace(/[√ß]/gi, 'c')
                .replace(/[√Ω]/gi, 'y')
                
                // Symboles et ponctuation
                .replace(/[‚Ç¨]/g, 'EUR')
                .replace(/[¬£]/g, 'GBP')
                .replace(/[¬•]/g, 'JPY')
                .replace(/[¬∞]/g, 'deg')
                .replace(/[%]/g, 'pct')
                
                // Tous types de tirets et traits d'union
                .replace(/[‚Äì‚Äî‚àí‚Äí]/g, '-')
                .replace(/[''‚Äö‚Äõ]/g, "'")
                .replace(/[""‚Äû‚Äü]/g, '"')
                .replace(/[‚Ä¶]/g, '...')
                
                // Supprimer TOUS les caract√®res non-ASCII (brutal mais efficace)
                .replace(/[^\x20-\x7E]/g, '?');
            
            console.log(`Nettoyage: "${text}" -> "${cleaned}"`);
            return cleaned;
        }

        // Alternative : fonction de nettoyage encore plus simple
        function ultraCleanTextForPDF(text) {
            if (!text) return '';
            
            // Ne garder QUE les caract√®res ASCII basiques
            return text
                .toString()
                .replace(/[^a-zA-Z0-9\s\.,;:!?()\-+=/]/g, '?')
                .trim();
        }

        // === TEMPLATE PDF ===
        let templatePDF = null;

        // === FONCTION MODIFICATION PDF AVEC TEMPLATE ===
        async function generateMarlowePDFFromTemplate(devisData) {
            if (!templatePDF) {
                throw new Error('Aucun template PDF charg√©. Veuillez d\'abord charger votre template.');
            }
            
            try {
                // Mode debug : afficher toutes les donn√©es avant traitement
                console.log('=== DEBUG DONN√âES AVANT NETTOYAGE ===');
                console.log('Num√©ro devis:', JSON.stringify(devisData.numeroDevis));
                console.log('Client nom:', JSON.stringify(devisData.client.nom));
                console.log('Client adresse:', JSON.stringify(devisData.client.adresse));
                console.log('Client email:', JSON.stringify(devisData.client.email));
                console.log('Client t√©l√©phone:', JSON.stringify(devisData.client.telephone));
                console.log('Produits:', JSON.stringify(devisData.produits));
                
                // Cloner le template
                const pdfDoc = await PDFLib.PDFDocument.load(await templatePDF.save());
                const pages = pdfDoc.getPages();
                const firstPage = pages[0];
                
                // Polices - essayer diff√©rentes polices
                let font, boldFont;
                try {
                    font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
                    boldFont = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);
                    console.log('‚úÖ Polices Helvetica charg√©es');
                } catch (fontError) {
                    console.log('‚ùå Erreur Helvetica, essai avec Courier');
                    font = await pdfDoc.embedFont(PDFLib.StandardFonts.Courier);
                    boldFont = await pdfDoc.embedFont(PDFLib.StandardFonts.CourierBold);
                }
                
                // === COORDONN√âES AJUST√âES SELON TON TEMPLATE ===
                
                // Test avec UNE SEULE ligne de texte d'abord
                try {
                    console.log('Test √©criture num√©ro devis...');
                    const cleanedDevisNumber = ultraCleanTextForPDF(devisData.numeroDevis);
                    console.log('Num√©ro nettoy√©:', JSON.stringify(cleanedDevisNumber));
                    
                    firstPage.drawText(cleanedDevisNumber, {
                        x: 240,
                        y: 695,
                        size: 14,
                        font: boldFont,
                        color: PDFLib.rgb(1, 1, 1)
                    });
                    console.log('‚úÖ Num√©ro devis √©crit avec succ√®s');
                } catch (error) {
                    console.log('‚ùå Erreur num√©ro devis:', error.message);
                    throw new Error('Erreur sur le num√©ro de devis: ' + error.message);
                }
                
                // Test nom client
                try {
                    console.log('Test √©criture nom client...');
                    const cleanedClientName = ultraCleanTextForPDF(devisData.client.nom);
                    console.log('Nom nettoy√©:', JSON.stringify(cleanedClientName));
                    
                    firstPage.drawText(cleanedClientName, {
                        x: 77,
                        y: 460,
                        size: 11,
                        font: boldFont,
                        color: PDFLib.rgb(0, 0, 0)
                    });
                    console.log('‚úÖ Nom client √©crit avec succ√®s');
                } catch (error) {
                    console.log('‚ùå Erreur nom client:', error.message);
                    throw new Error('Erreur sur le nom client: ' + error.message);
                }
                
                // Si on arrive ici, on continue avec le reste...
                console.log('‚úÖ Tests basiques OK, continuation...');
                
                // Adresse client (avec nettoyage ligne par ligne)
                if (devisData.client.adresse) {
                    const addressLines = devisData.client.adresse.split('\n');
                    addressLines.forEach((line, index) => {
                        const cleanedLine = ultraCleanTextForPDF(line);
                        console.log(`Adresse ligne ${index}:`, JSON.stringify(cleanedLine));
                        
                        firstPage.drawText(cleanedLine, {
                            x: 77,
                            y: 460 - 20 - (index * 15),
                            size: 10,
                            font: font,
                            color: PDFLib.rgb(0, 0, 0)
                        });
                    });
                }
                
                // Email et t√©l√©phone
                let infoY = 460 - 20 - (devisData.client.adresse ? devisData.client.adresse.split('\n').length * 15 : 0);
                
                if (devisData.client.email) {
                    const cleanedEmail = ultraCleanTextForPDF(`Email: ${devisData.client.email}`);
                    firstPage.drawText(cleanedEmail, {
                        x: 77,
                        y: infoY - 10,
                        size: 10,
                        font: font,
                        color: PDFLib.rgb(0, 0, 0)
                    });
                    infoY -= 15;
                }
                
                if (devisData.client.telephone) {
                    const cleanedPhone = ultraCleanTextForPDF(`Tel: ${devisData.client.telephone}`);
                    firstPage.drawText(cleanedPhone, {
                        x: 77,
                        y: infoY - 10,
                        size: 10,
                        font: font,
                        color: PDFLib.rgb(0, 0, 0)
                    });
                }
                
                // === PRODUITS DANS LE TABLEAU ===
                let productY = 350;
                
                devisData.produits.forEach((produit, index) => {
                    const currentY = productY - (index * 20);
                    
                    // Nom du produit
                    const cleanedProductName = ultraCleanTextForPDF(produit.nom);
                    firstPage.drawText(cleanedProductName, {
                        x: 77,
                        y: currentY,
                        size: 10,
                        font: font,
                        color: PDFLib.rgb(0, 0, 0)
                    });
                    
                    // Prix unitaire
                    const cleanedPrice = ultraCleanTextForPDF(`${produit.prix} EUR`);
                    firstPage.drawText(cleanedPrice, {
                        x: 310,
                        y: currentY,
                        size: 10,
                        font: font,
                        color: PDFLib.rgb(0, 0, 0)
                    });
                    
                    // Quantit√©
                    const cleanedQuantity = ultraCleanTextForPDF(produit.quantite.toString());
                    firstPage.drawText(cleanedQuantity, {
                        x: 470,
                        y: currentY,
                        size: 10,
                        font: font,
                        color: PDFLib.rgb(0, 0, 0)
                    });
                    
                    // Total
                    const cleanedTotal = ultraCleanTextForPDF(`${produit.total} EUR`);
                    firstPage.drawText(cleanedTotal, {
                        x: 640,
                        y: currentY,
                        size: 10,
                        font: font,
                        color: PDFLib.rgb(0, 0, 0)
                    });
                });
                
                // === TOTAUX ===
                const totalsY = 200;
                
                // Sous-total
                const cleanedSubtotal = ultraCleanTextForPDF(`${devisData.totaux.sousTotal} EUR`);
                firstPage.drawText(cleanedSubtotal, {
                    x: 710,
                    y: totalsY + 40,
                    size: 11,
                    font: font,
                    color: PDFLib.rgb(0, 0, 0)
                });
                
                // TVA - conversion sp√©ciale pour √©viter les d√©cimales fran√ßaises
                const tvaValue = Math.round(devisData.totaux.tva * 100) / 100; // Arrondir √† 2 d√©cimales
                const cleanedTVA = ultraCleanTextForPDF(`${tvaValue} EUR`);
                firstPage.drawText(cleanedTVA, {
                    x: 710,
                    y: totalsY + 20,
                    size: 11,
                    font: font,
                    color: PDFLib.rgb(0, 0, 0)
                });
                
                // Total final
                const totalValue = Math.round(devisData.totaux.total * 100) / 100;
                const cleanedTotal = ultraCleanTextForPDF(`${totalValue} EUR`);
                firstPage.drawText(cleanedTotal, {
                    x: 710,
                    y: totalsY - 10,
                    size: 12,
                    font: boldFont,
                    color: PDFLib.rgb(0, 0, 0)
                });
                
                // Date signature
                const today = new Date().toLocaleDateString('en-US'); // Format US pour √©viter les probl√®mes
                const cleanedDate = ultraCleanTextForPDF(today);
                firstPage.drawText(cleanedDate, {
                    x: 570,
                    y: 85,
                    size: 10,
                    font: font,
                    color: PDFLib.rgb(0, 0, 0)
                });
                
                console.log('‚úÖ PDF g√©n√©r√© avec succ√®s !');
                return pdfDoc;
                
            } catch (error) {
                console.log('‚ùå Erreur d√©taill√©e:', error);
                throw new Error('Erreur lors de la modification du template: ' + error.message);
            }
        }

        // === FONCTION ENVOI DISCORD ===
        async function sendToDiscord(pdfBlob, devisData) {
            if (!discordConfig.webhookUrl) {
                throw new Error('URL de webhook Discord non configur√©e');
            }
            
            const formData = new FormData();
            
            // Cr√©er l'embed Discord
            const embed = {
                title: "üç∑ Nouveau Devis Marlowe Vineyard",
                color: 0x8B5A9F, // Couleur violette de Marlowe
                fields: [
                    {
                        name: "üìã Num√©ro de devis",
                        value: devisData.numeroDevis,
                        inline: true
                    },
                    {
                        name: "üë§ Client",
                        value: devisData.client.nom,
                        inline: true
                    },
                    {
                        name: "üí∞ Montant total",
                        value: `${devisData.totaux.total.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} ‚Ç¨`,
                        inline: true
                    },
                    {
                        name: "üìß Email",
                        value: devisData.client.email || "Non renseign√©",
                        inline: true
                    },
                    {
                        name: "üìû T√©l√©phone",
                        value: devisData.client.telephone || "Non renseign√©",
                        inline: true
                    },
                    {
                        name: "üõí Produits",
                        value: devisData.produits.map(p => `‚Ä¢ ${p.nom} (${p.quantite}x)`).join('\n'),
                        inline: false
                    }
                ],
                footer: {
                    text: "Marlowe Vineyard - Sistema de Devis"
                },
                timestamp: new Date().toISOString()
            };
            
            const payload = {
                content: "üìã **Nouveau devis g√©n√©r√© !**",
                embeds: [embed],
                username: discordConfig.username
            };
            
            formData.append('payload_json', JSON.stringify(payload));
            formData.append('file', pdfBlob, `Devis-${devisData.numeroDevis}.pdf`);
            
            const response = await fetch(discordConfig.webhookUrl, {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                throw new Error(`Erreur Discord: ${response.status}`);
            }
            
            return response;
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Charger la configuration Discord
            if (discordConfig.webhookUrl) {
                console.log('Configuration Discord charg√©e');
            }

            // === GESTION TEMPLATE PDF ===
            // Chargement automatique du template au d√©marrage
            tryLoadDefaultTemplate();

            // Gestion des boutons de documents
            document.querySelectorAll('.document-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const documentType = this.dataset.document;
                    
                    if (documentType === 'devis') {
                        if (!templatePDF) {
                            notify.warning('Template manquant', 'Veuillez d\'abord charger votre template PDF.');
                            return;
                        }
                        openDevisForm();
                    } else {
                        const documentNames = {
                            'facture': 'Formulaire de Facture',
                            'livraison': 'Formulaire de Bon de Livraison',
                            'visite': 'Formulaire de Contrat de Visite',
                            'inventaire': 'G√©n√©ration de Rapport d\'Inventaire',
                            'ventes': 'G√©n√©ration de Rapport de Ventes',
                            'commande': 'Formulaire de Bon de Commande',
                            'production': 'Formulaire de Fiche de Production'
                        };
                        
                        notify.info(
                            'Formulaire en pr√©paration',
                            `Le ${documentNames[documentType]} sera bient√¥t disponible !`
                        );
                    }
                    
                    // Animation du bouton
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = 'scale(1)';
                    }, 150);
                });
            });

            // Gestion de la d√©connexion
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                
                const confirmNotification = notify.info(
                    'Confirmation de d√©connexion', 
                    '√ätes-vous s√ªr de vouloir vous d√©connecter ?', 
                    10000
                );
                
                const notificationContent = confirmNotification.querySelector('.notification-content');
                const buttonsDiv = document.createElement('div');
                buttonsDiv.style.marginTop = '1rem';
                buttonsDiv.style.display = 'flex';
                buttonsDiv.style.gap = '0.5rem';
                
                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'cta-button btn-warning';
                confirmBtn.style.fontSize = '0.8rem';
                confirmBtn.style.padding = '0.5rem 1rem';
                confirmBtn.textContent = 'D√©connexion';
                
                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'cta-button btn-secondary';
                cancelBtn.style.fontSize = '0.8rem';
                cancelBtn.style.padding = '0.5rem 1rem';
                cancelBtn.textContent = 'Annuler';
                
                buttonsDiv.appendChild(cancelBtn);
                buttonsDiv.appendChild(confirmBtn);
                notificationContent.appendChild(buttonsDiv);
                
                confirmBtn.addEventListener('click', () => {
                    notify.remove(confirmNotification);
                    notify.info('D√©connexion en cours', 'Redirection vers l\'accueil...');
                    setTimeout(() => {
                        window.location.href = '../index.html';
                    }, 1000);
                });
                
                cancelBtn.addEventListener('click', () => {
                    notify.remove(confirmNotification);
                });
            });

            console.log('Page Documents charg√©e avec succ√®s!');
        });

        // === GESTION TEMPLATE PDF ===
        
        async function tryLoadDefaultTemplate() {
            // Bas√© sur ta structure : racine/assets/template-devis.pdf
            const possiblePaths = [
                '../assets/template-devis.pdf',    // Si dans intranet/ ou public/
                './assets/template-devis.pdf',     // Si √† la racine  
                '/assets/template-devis.pdf',      // Path absolu
                'assets/template-devis.pdf',       // Path relatif simple
                '../../assets/template-devis.pdf'  // Si dans un sous-sous-dossier
            ];
            
            showTemplateStatus('üîÑ Recherche du template...', 'info');
            console.log('=== DEBUG TEMPLATE ===');
            console.log('URL actuelle:', window.location.href);
            console.log('Path actuel:', window.location.pathname);
            
            for (let i = 0; i < possiblePaths.length; i++) {
                const path = possiblePaths[i];
                try {
                    console.log(`[${i+1}/${possiblePaths.length}] Test du path: ${path}`);
                    
                    const response = await fetch(path);
                    console.log(`Response status: ${response.status} (${response.statusText})`);
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        console.log(`Blob size: ${blob.size} bytes`);
                        
                        if (blob.size > 0) {
                            await loadTemplateFromBlob(blob, 'template-devis.pdf');
                            
                            showTemplateStatus(`‚úÖ Template charg√© depuis: ${path}`, 'success');
                            console.log(`‚úÖ SUCCESS! Template charg√© depuis: ${path}`);
                            return; // Succ√®s !
                        } else {
                            console.log(`‚ùå Blob vide pour ${path}`);
                        }
                    }
                } catch (error) {
                    console.log(`‚ùå Erreur avec ${path}:`, error.message);
                }
            }
            
            // Si aucun path n'a fonctionn√©
            showTemplateStatus('‚ùå Template non trouv√©. V√©rifiez la console pour plus d\'infos.', 'error');
            console.error('‚ùå Template non trouv√© dans aucun des paths test√©s');
            console.log('Votre structure semble √™tre:');
            console.log('racine/assets/template-devis.pdf');
            console.log('racine/intranet/documents.html (probablement)');
            console.log('Le path ../assets/template-devis.pdf devrait fonctionner...');
        }

        async function loadTemplateFromBlob(blob, filename) {
            const arrayBuffer = await blob.arrayBuffer();
            templatePDF = await PDFLib.PDFDocument.load(arrayBuffer);
        }

        function showTemplateStatus(message, type) {
            const statusDiv = document.getElementById('templateStatus');
            const colors = {
                success: '#d4edda; color: #155724; border: 1px solid #c3e6cb',
                error: '#f8d7da; color: #721c24; border: 1px solid #f5c6cb',
                info: '#cce7ff; color: #004085; border: 1px solid #b8daff'
            };
            
            statusDiv.innerHTML = `<div style="background: ${colors[type]}; padding: 10px; border-radius: 5px; font-size: 14px;">${message}</div>`;
            
            setTimeout(() => {
                if (type !== 'success') {
                    statusDiv.innerHTML = '';
                }
            }, 5000);
        }

        // === SYST√àME DE DEVIS ===

        // Produits disponibles avec prix
        const produits = {
            'marlowe-rouge': { nom: 'Marlowe Rouge Reserve', prix: 450 },
            'marlowe-blanc': { nom: 'Marlowe Blanc Premium', prix: 380 },
            'marlowe-prestige': { nom: 'Marlowe Prestige', prix: 850 },
            'marlowe-rose': { nom: 'Marlowe Ros√©', prix: 320 },
            'marlowe-vintage': { nom: 'Marlowe Vintage', prix: 1200 },
            'coffret-degustation': { nom: 'Coffret D√©gustation', prix: 1800 }
        };

        let productCounter = 0;
        let devisData = {
            client: {},
            produits: [],
            totaux: { sousTotal: 0, tva: 0, total: 0 }
        };

        // === CONFIGURATION DISCORD ===
        function openDiscordConfig() {
            document.getElementById('discordConfigModal').style.display = 'flex';
            document.getElementById('webhookUrl').value = discordConfig.webhookUrl;
            document.getElementById('discordUsername').value = discordConfig.username;
        }

        function closeDiscordConfig() {
            document.getElementById('discordConfigModal').style.display = 'none';
        }

        function saveDiscordConfig() {
            const webhookUrl = document.getElementById('webhookUrl').value.trim();
            const username = document.getElementById('discordUsername').value.trim() || 'Marlowe Vineyard';
            
            if (webhookUrl && !webhookUrl.includes('discord.com/api/webhooks/')) {
                notify.error('URL invalide', 'Veuillez entrer une URL de webhook Discord valide');
                return;
            }
            
            discordConfig.webhookUrl = webhookUrl;
            discordConfig.username = username;
            
            localStorage.setItem('marlowe_webhook_url', webhookUrl);
            localStorage.setItem('marlowe_discord_username', username);
            
            notify.success('Configuration sauvegard√©e', 'Les param√®tres Discord ont √©t√© mis √† jour');
            closeDiscordConfig();
        }

        async function testDiscordWebhook() {
            const webhookUrl = document.getElementById('webhookUrl').value.trim();
            
            if (!webhookUrl) {
                notify.error('URL manquante', 'Veuillez entrer une URL de webhook');
                return;
            }
            
            try {
                const testPayload = {
                    content: "üß™ **Test de connexion Marlowe Vineyard**",
                    embeds: [{
                        title: "‚úÖ Webhook configur√© avec succ√®s !",
                        description: "Le syst√®me de devis Marlowe Vineyard est maintenant connect√© √† ce channel Discord.",
                        color: 0x8B5A9F,
                        footer: {
                            text: "Marlowe Vineyard - Test de connexion"
                        },
                        timestamp: new Date().toISOString()
                    }],
                    username: document.getElementById('discordUsername').value || 'Marlowe Vineyard'
                };
                
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testPayload)
                });
                
                if (!response.ok) {
                    throw new Error(`Erreur ${response.status}`);
                }
                
                notify.success('Test r√©ussi !', 'V√©rifiez votre channel Discord');
                
            } catch (error) {
                notify.error('Test √©chou√©', error.message);
            }
        }

        function openDevisForm() {
            const modal = document.getElementById('devisModal');
            modal.style.display = 'flex';
            
            // R√©initialiser le formulaire
            resetDevisForm();
            
            // G√©n√©rer un nouveau num√©ro de devis
            generateDevisNumber();
            
            // Ajouter la premi√®re ligne de produit
            addProductLine();
            
            // Gestion des √©v√©nements du modal
            document.getElementById('closeDevisModal').onclick = closeDevisModal;
            document.getElementById('cancelDevis').onclick = closeDevisModal;
            document.getElementById('addProductBtn').onclick = addProductLine;
            document.getElementById('generateDevis').onclick = generatePDF;
            document.getElementById('generateAndSendDevis').onclick = generateAndSendToDiscord;
            document.getElementById('previewDevis').onclick = previewDevis;
            
            // Fermer en cliquant √† l'ext√©rieur
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeDevisModal();
                }
            };
        }

        function closeDevisModal() {
            document.getElementById('devisModal').style.display = 'none';
        }

        function resetDevisForm() {
            // Vider les champs
            document.getElementById('client-nom').value = '';
            document.getElementById('client-email').value = '';
            document.getElementById('client-adresse').value = '';
            document.getElementById('client-telephone').value = '';
            
            // Vider les produits
            document.getElementById('products-container').innerHTML = '';
            productCounter = 0;
            
            // R√©initialiser les totaux
            updateTotals();
        }

        function generateDevisNumber() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            
            const devisNumber = `DV${year}${month}${day}-${random}`;
            document.getElementById('numero-devis').value = devisNumber;
        }

        function addProductLine() {
            productCounter++;
            const container = document.getElementById('products-container');
            
            const productLine = document.createElement('div');
            productLine.className = 'product-line';
            productLine.dataset.id = productCounter;
            
            let buttonHTML = '';
            if (productCounter > 1) {
                buttonHTML = '<button type="button" class="btn-remove-product" onclick="removeProductLine(' + productCounter + ')"><i class="fas fa-trash"></i></button>';
            }
            
            let optionsHTML = '<option value="">S√©lectionnez un produit</option>';
            Object.entries(produits).forEach(([key, prod]) => {
                optionsHTML += '<option value="' + key + '" data-prix="' + prod.prix + '">' + prod.nom + ' - ' + prod.prix + '‚Ç¨</option>';
            });
            
            productLine.innerHTML = 
                '<div class="product-line-header">' +
                    '<span class="product-number">Produit ' + productCounter + '</span>' +
                    buttonHTML +
                '</div>' +
                '<div class="form-row">' +
                    '<div class="form-group flex-2">' +
                        '<label class="form-label">Produit</label>' +
                        '<select class="form-select product-select" data-id="' + productCounter + '" onchange="updateProductPrice(' + productCounter + ')">' +
                            optionsHTML +
                        '</select>' +
                    '</div>' +
                    '<div class="form-group">' +
                        '<label class="form-label">Prix unitaire</label>' +
                        '<input type="text" class="form-input product-price" data-id="' + productCounter + '" readonly placeholder="0,00 ‚Ç¨">' +
                    '</div>' +
                    '<div class="form-group">' +
                        '<label class="form-label">Quantit√©</label>' +
                        '<input type="number" class="form-input product-quantity" data-id="' + productCounter + '" min="1" value="1" onchange="updateLineTotal(' + productCounter + ')">' +
                    '</div>' +
                    '<div class="form-group">' +
                        '<label class="form-label">Total HT</label>' +
                        '<input type="text" class="form-input product-total" data-id="' + productCounter + '" readonly placeholder="0,00 ‚Ç¨">' +
                    '</div>' +
                '</div>';
            
            container.appendChild(productLine);
        }

        function removeProductLine(id) {
            const line = document.querySelector(`[data-id="${id}"]`);
            if (line) {
                line.remove();
                updateTotals();
                notify.info('Produit supprim√©', 'La ligne de produit a √©t√© retir√©e du devis.');
            }
        }

        function updateProductPrice(id) {
            const select = document.querySelector(`select[data-id="${id}"]`);
            const priceInput = document.querySelector(`input.product-price[data-id="${id}"]`);
            const quantityInput = document.querySelector(`input.product-quantity[data-id="${id}"]`);
            
            if (select.value) {
                const prix = produits[select.value].prix;
                priceInput.value = `${prix},00 ‚Ç¨`;
                updateLineTotal(id);
            } else {
                priceInput.value = '';
                updateLineTotal(id);
            }
        }

        function updateLineTotal(id) {
            const select = document.querySelector(`select[data-id="${id}"]`);
            const quantityInput = document.querySelector(`input.product-quantity[data-id="${id}"]`);
            const totalInput = document.querySelector(`input.product-total[data-id="${id}"]`);
            
            if (select.value && quantityInput.value) {
                const prix = produits[select.value].prix;
                const quantity = parseInt(quantityInput.value) || 0;
                const total = prix * quantity;
                
                totalInput.value = `${total.toLocaleString('fr-FR')},00 ‚Ç¨`;
            } else {
                totalInput.value = '';
            }
            
            updateTotals();
        }

        function updateTotals() {
            let sousTotal = 0;
            
            // Calculer le sous-total
            document.querySelectorAll('.product-line').forEach(line => {
                const id = line.dataset.id;
                const select = document.querySelector(`select[data-id="${id}"]`);
                const quantityInput = document.querySelector(`input.product-quantity[data-id="${id}"]`);
                
                if (select && select.value && quantityInput && quantityInput.value) {
                    const prix = produits[select.value].prix;
                    const quantity = parseInt(quantityInput.value) || 0;
                    sousTotal += prix * quantity;
                }
            });
            
            // Calculer TVA et total
            const tva = sousTotal * 0.21;
            const total = sousTotal + tva;
            
            // Mettre √† jour l'affichage
            document.getElementById('sous-total').textContent = `${sousTotal.toLocaleString('fr-FR')},00 ‚Ç¨`;
            document.getElementById('tva-montant').textContent = `${tva.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} ‚Ç¨`;
            document.getElementById('total-final').textContent = `${total.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} ‚Ç¨`;
            
            // Sauvegarder dans devisData
            devisData.totaux = { sousTotal, tva, total };
        }

        function previewDevis() {
            // R√©cup√©rer les donn√©es du formulaire
            collectDevisData();
            
            // Afficher la pr√©visualisation
            let preview = '<h3>Devis ' + devisData.numeroDevis + '</h3>' +
                '<h4>Client: ' + devisData.client.nom + '</h4>' +
                '<p>' + devisData.client.adresse + '</p>';
            
            if (devisData.client.email) {
                preview += '<p>Email: ' + devisData.client.email + '</p>';
            }
            
            if (devisData.client.telephone) {
                preview += '<p>T√©l: ' + devisData.client.telephone + '</p>';
            }
            
            preview += '<h4>Produits:</h4><ul>';
            
            devisData.produits.forEach(prod => {
                preview += '<li>' + prod.nom + ' - Quantit√©: ' + prod.quantite + ' - Total: ' + prod.total.toLocaleString('fr-FR') + ',00 ‚Ç¨</li>';
            });
            
            preview += '</ul><h4>Totaux:</h4>' +
                '<p>Sous-total HT: ' + devisData.totaux.sousTotal.toLocaleString('fr-FR') + ',00 ‚Ç¨</p>' +
                '<p>TVA (21%): ' + devisData.totaux.tva.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' ‚Ç¨</p>' +
                '<p><strong>Total TTC: ' + devisData.totaux.total.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' ‚Ç¨</strong></p>';
            
            notify.info('Pr√©visualisation', preview);
        }

        function collectDevisData() {
            // Collecter les infos client
            devisData.client = {
                nom: document.getElementById('client-nom').value,
                email: document.getElementById('client-email').value,
                adresse: document.getElementById('client-adresse').value,
                telephone: document.getElementById('client-telephone').value
            };
            
            devisData.numeroDevis = document.getElementById('numero-devis').value;
            
            // Collecter les produits
            devisData.produits = [];
            document.querySelectorAll('.product-line').forEach(line => {
                const id = line.dataset.id;
                const select = document.querySelector(`select[data-id="${id}"]`);
                const quantityInput = document.querySelector(`input.product-quantity[data-id="${id}"]`);
                
                if (select && select.value && quantityInput && quantityInput.value) {
                    const produit = produits[select.value];
                    const quantity = parseInt(quantityInput.value);
                    const total = produit.prix * quantity;
                    
                    devisData.produits.push({
                        nom: produit.nom,
                        prix: produit.prix,
                        quantite: quantity,
                        total: total
                    });
                }
            });
        }

        function generatePDF() {
            // Valider le formulaire
            if (!document.getElementById('client-nom').value || !document.getElementById('client-adresse').value) {
                notify.error('Formulaire incomplet', 'Veuillez remplir au moins le nom et l\'adresse du client.');
                return;
            }
            
            // V√©rifier le template
            if (!templatePDF) {
                notify.error('Template manquant', 'Veuillez d\'abord charger votre template PDF.');
                return;
            }
            
            // V√©rifier qu'il y a au moins un produit
            let hasValidProducts = false;
            
            document.querySelectorAll('.product-line').forEach(line => {
                const id = line.dataset.id;
                const select = document.querySelector('select[data-id="' + id + '"]');
                if (select && select.value) {
                    hasValidProducts = true;
                }
            });
            
            if (!hasValidProducts) {
                notify.error('Aucun produit', 'Veuillez s√©lectionner au moins un produit.');
                return;
            }
            
            // Collecter les donn√©es
            collectDevisData();
            
            try {
                notify.info('G√©n√©ration en cours...', 'Cr√©ation du PDF avec votre template...');
                
                generateMarlowePDFFromTemplate(devisData).then(async (pdfDoc) => {
                    const pdfBytes = await pdfDoc.save();
                    
                    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Devis-${devisData.numeroDevis}-${devisData.client.nom.replace(/\s+/g, '-')}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    notify.success('Devis g√©n√©r√© !', `Le devis ${devisData.numeroDevis} a √©t√© cr√©√© avec succ√®s.`);
                    
                    // Fermer le modal apr√®s g√©n√©ration
                    setTimeout(() => {
                        closeDevisModal();
                    }, 2000);
                }).catch(error => {
                    notify.error('Erreur PDF', 'Erreur lors de la g√©n√©ration : ' + error.message);
                });
                
            } catch (error) {
                notify.error('Erreur PDF', 'Erreur lors de la g√©n√©ration : ' + error.message);
            }
        }

        async function generateAndSendToDiscord() {
            // Valider le formulaire
            if (!document.getElementById('client-nom').value || !document.getElementById('client-adresse').value) {
                notify.error('Formulaire incomplet', 'Veuillez remplir au moins le nom et l\'adresse du client.');
                return;
            }
            
            // V√©rifier le template
            if (!templatePDF) {
                notify.error('Template manquant', 'Veuillez d\'abord charger votre template PDF.');
                return;
            }
            
            // V√©rifier qu'il y a au moins un produit
            let hasValidProducts = false;
            
            document.querySelectorAll('.product-line').forEach(line => {
                const id = line.dataset.id;
                const select = document.querySelector('select[data-id="' + id + '"]');
                if (select && select.value) {
                    hasValidProducts = true;
                }
            });
            
            if (!hasValidProducts) {
                notify.error('Aucun produit', 'Veuillez s√©lectionner au moins un produit.');
                return;
            }

            // V√©rifier la configuration Discord
            if (!discordConfig.webhookUrl) {
                notify.warning('Discord non configur√©', 'Configurez d\'abord votre webhook Discord.');
                openDiscordConfig();
                return;
            }
            
            // Collecter les donn√©es
            collectDevisData();
            
            try {
                notify.info('G√©n√©ration en cours...', 'Cr√©ation du PDF et envoi sur Discord...');
                
                const pdfDoc = await generateMarlowePDFFromTemplate(devisData);
                const pdfBytes = await pdfDoc.save();
                const pdfBlob = new Blob([pdfBytes], { type: 'application/pdf' });
                
                await sendToDiscord(pdfBlob, devisData);
                
                notify.success('Succ√®s complet !', `Devis ${devisData.numeroDevis} g√©n√©r√© et envoy√© sur Discord avec succ√®s !`);
                
                // Fermer le modal apr√®s g√©n√©ration
                setTimeout(() => {
                    closeDevisModal();
                }, 3000);
                
            } catch (error) {
                notify.error('Erreur', 'Erreur lors de l\'envoi : ' + error.message);
            }
        }
    </script>
</body>
</html>
