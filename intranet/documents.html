<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documents - Marlowe Vineyard Intranet</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
    <!-- PDF-lib pour modifier les PDFs existants -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav-container">
            <a href="../index.html" class="logo">
                <i class="fas fa-shield-alt"></i>
                Marlowe Intranet
            </a>
            <ul class="nav-menu">
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="inventaire.html">Inventaire</a></li>
                <li><a href="#commandes">Commandes</a></li>
                <li><a href="documents.html" class="active">Documents</a></li>
                <li><a href="configuration.html">Configuration</a></li>
                <li><a href="../index.html" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> D√©connexion
                </a></li>
            </ul>
        </nav>
    </header>

    <!-- Hero Section -->
    <section class="hero hero-intranet">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        
        <div class="hero-content">
            <h1>G√©n√©ration de Documents</h1>
            <p class="subtitle">Cr√©ation automatis√©e de documents</p>
            <p>G√©n√©rez rapidement vos devis, factures et autres documents commerciaux avec calculs automatiques.</p>
        </div>
    </section>



    <!-- Modal Devis -->
    <div id="devisModal" class="modal-devis">
        <div class="modal-devis-content">
            <div class="modal-devis-header">
                <h3><i class="fas fa-file-invoice-dollar"></i> Cr√©er un Devis</h3>
                <span class="modal-close" id="closeDevisModal">&times;</span>
            </div>
            <div class="modal-devis-body">
                
                <!-- Informations Client -->
                <div class="devis-section">
                    <h4><i class="fas fa-user"></i> Informations Client</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nom complet *</label>
                            <input type="text" id="client-nom" class="form-input" required placeholder="Nom et pr√©nom du client">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" id="client-email" class="form-input" placeholder="email@exemple.com">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Adresse compl√®te *</label>
                        <textarea id="client-adresse" class="form-textarea" rows="3" required placeholder="Adresse, code postal, ville"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">T√©l√©phone</label>
                            <input type="tel" id="client-telephone" class="form-input" placeholder="+33 1 23 45 67 89">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Num√©ro de devis</label>
                            <input type="text" id="numero-devis" class="form-input" readonly>
                        </div>
                    </div>
                </div>

                <!-- S√©lection des Produits -->
                <div class="devis-section">
                    <div class="section-header">
                        <h4><i class="fas fa-wine-bottle"></i> S√©lection des Produits</h4>
                        <button type="button" class="btn-add-product" id="addProductBtn">
                            <i class="fas fa-plus"></i> Ajouter
                        </button>
                    </div>
                    <div id="products-container">
                        <!-- Les lignes de produits seront ajout√©es ici -->
                    </div>
                </div>

                <!-- Totaux -->
                <div class="devis-section">
                    <h4><i class="fas fa-calculator"></i> R√©capitulatif</h4>
                    <div class="totals-container">
                        <div class="total-line">
                            <span class="total-label">Sous-total HT :</span>
                            <span class="total-value" id="sous-total">0.00$</span>
                        </div>
                        <div class="total-line">
                            <span class="total-label">TVA (21%) :</span>
                            <span class="total-value" id="tva-montant">0.00$</span>
                        </div>
                        <div class="total-line total-final">
                            <span class="total-label">Total TTC :</span>
                            <span class="total-value" id="total-final">0.00$</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-devis-footer">
                <button type="button" class="cta-button btn-secondary" id="cancelDevis">
                    <i class="fas fa-times"></i> Annuler
                </button>
                <button type="button" class="cta-button btn-success" id="generateDevisComplete">
                    <i class="fas fa-check"></i> Confirmer le Devis
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Facture -->
    <div id="factureModal" class="modal-devis">
        <div class="modal-devis-content">
            <div class="modal-devis-header">
                <h3><i class="fas fa-receipt"></i> Cr√©er une Facture</h3>
                <span class="modal-close" id="closeFactureModal">&times;</span>
            </div>
            <div class="modal-devis-body">
                
                <!-- Informations Client -->
                <div class="devis-section">
                    <h4><i class="fas fa-user"></i> Informations Client</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nom complet *</label>
                            <input type="text" id="facture-client-nom" class="form-input" required placeholder="Nom et pr√©nom du client">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" id="facture-client-email" class="form-input" placeholder="email@exemple.com">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Adresse compl√®te *</label>
                        <textarea id="facture-client-adresse" class="form-textarea" rows="3" required placeholder="Adresse, code postal, ville"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">T√©l√©phone</label>
                            <input type="tel" id="facture-client-telephone" class="form-input" placeholder="+33 1 23 45 67 89">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Num√©ro de facture</label>
                            <input type="text" id="numero-facture" class="form-input" readonly>
                        </div>
                    </div>
                </div>
    
                <!-- S√©lection des Produits -->
                <div class="devis-section">
                    <div class="section-header">
                        <h4><i class="fas fa-wine-bottle"></i> S√©lection des Produits</h4>
                        <button type="button" class="btn-add-product" id="addFactureProductBtn">
                            <i class="fas fa-plus"></i> Ajouter
                        </button>
                    </div>
                    <div id="facture-products-container">
                        <!-- Les lignes de produits seront ajout√©es ici -->
                    </div>
                </div>
    
                <!-- Totaux -->
                <div class="devis-section">
                    <h4><i class="fas fa-calculator"></i> R√©capitulatif</h4>
                    <div class="totals-container">
                        <div class="total-line">
                            <span class="total-label">Sous-total HT :</span>
                            <span class="total-value" id="facture-sous-total">0.00$</span>
                        </div>
                        <div class="total-line">
                            <span class="total-label">TVA (21%) :</span>
                            <span class="total-value" id="facture-tva-montant">0.00$</span>
                        </div>
                        <div class="total-line total-final">
                            <span class="total-label">Total TTC :</span>
                            <span class="total-value" id="facture-total-final">0.00$</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-devis-footer">
                <button type="button" class="cta-button btn-secondary" id="cancelFacture">
                    <i class="fas fa-times"></i> Annuler
                </button>
                <button type="button" class="cta-button btn-success" id="generateFactureComplete">
                    <i class="fas fa-check"></i> Confirmer la Facture
                </button>
            </div>
        </div>
    </div>

    <!-- Documents Section -->
    <section class="documents-section">
        <div class="documents-container">
            
            <!-- Documents Clients -->
            <div class="document-category">
                <div class="category-header">
                    <h2><i class="fas fa-user-tie"></i> Documents Clients</h2>
                    <p>Cr√©ez tous vos documents commerciaux destin√©s aux clients</p>

                    <div id="templateStatus" style="margin-top: 15px; text-align: center;"></div>
                </div>
                
                <div class="documents-grid">
                    <div class="document-card">
                        <div class="document-icon">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                        <h3>Devis Client</h3>
                        <p>G√©n√©rez un devis personnalis√© avec calculs automatiques des totaux HT/TTC et envoi Discord</p>
                        <button class="cta-button btn-success document-btn" data-document="devis">
                            <i class="fas fa-plus"></i> Cr√©er un Devis
                        </button>
                    </div>

                    <div class="document-card">
                        <div class="document-icon">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <h3>Facture</h3>
                        <p>√âmettez une facture apr√®s commande avec d√©tail des produits et montants</p>
                        <button class="cta-button btn-primary document-btn" data-document="facture">
                            <i class="fas fa-plus"></i> Cr√©er une Facture
                        </button>
                    </div>

                    <div class="document-card">
                        <div class="document-icon">
                            <i class="fas fa-truck"></i>
                        </div>
                        <h3>Bon de Livraison</h3>
                        <p>Pr√©parez les bons de livraison pour les exp√©ditions et livraisons clients</p>
                        <button class="cta-button btn-info document-btn" data-document="livraison">
                            <i class="fas fa-plus"></i> Cr√©er un Bon
                        </button>
                    </div>

                    <div class="document-card">
                        <div class="document-icon">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <h3>Contrat de Visite</h3>
                        <p>Formalisez les r√©servations de visites avec conditions et tarification</p>
                        <button class="cta-button btn-purple document-btn" data-document="visite">
                            <i class="fas fa-plus"></i> Cr√©er un Contrat
                        </button>
                    </div>
                </div>
            </div>

            <!-- Documents Internes -->
            <div class="document-category">
                <div class="category-header">
                    <h2><i class="fas fa-building"></i> Documents Internes</h2>
                    <p>G√©rez vos documents internes et rapports d'activit√©</p>
                </div>
                
                <div class="documents-grid">
                    <div class="document-card">
                        <div class="document-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <h3>Rapport d'Inventaire</h3>
                        <p>G√©n√©rez un rapport d√©taill√© de l'√©tat actuel des stocks et valeurs</p>
                        <button class="cta-button btn-warning document-btn" data-document="inventaire">
                            <i class="fas fa-plus"></i> G√©n√©rer le Rapport
                        </button>
                    </div>

                    <div class="document-card">
                        <div class="document-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <h3>Rapport de Ventes</h3>
                        <p>Synth√®se des ventes par p√©riode avec analyse des performances</p>
                        <button class="cta-button btn-success document-btn" data-document="ventes">
                            <i class="fas fa-plus"></i> G√©n√©rer le Rapport
                        </button>
                    </div>

                    <div class="document-card">
                        <div class="document-icon">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <h3>Bon de Commande</h3>
                        <p>Commandes fournisseurs pour r√©approvisionnement en mati√®res premi√®res</p>
                        <button class="cta-button btn-info document-btn" data-document="commande">
                            <i class="fas fa-plus"></i> Cr√©er une Commande
                        </button>
                    </div>

                    <div class="document-card">
                        <div class="document-icon">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <h3>Fiche de Production</h3>
                        <p>Documenter les √©tapes de production et qualit√© des cuv√©es</p>
                        <button class="cta-button btn-purple document-btn" data-document="production">
                            <i class="fas fa-plus"></i> Cr√©er une Fiche
                        </button>
                    </div>
                </div>
            </div>

            <!-- Statistiques -->
            <div class="documents-stats">
                <div class="stats-header">
                    <h3><i class="fas fa-chart-pie"></i> Statistiques Documents</h3>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number">47</div>
                        <div class="stat-label">Devis ce mois</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">23</div>
                        <div class="stat-label">Factures √©mises</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">15</div>
                        <div class="stat-label">Livraisons</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">8</div>
                        <div class="stat-label">Rapports g√©n√©r√©s</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2025 Marlowe Vineyard - Intranet Priv√© | Acc√®s Restreint</p>
    </footer>

    <script src="../script.js"></script>
    <script>
        // === CONFIGURATION DISCORD ===
        // REMPLACEZ 'VOTRE_WEBHOOK_URL_ICI' par votre vraie URL de webhook Discord
        const DISCORD_WEBHOOK_URL = 'https://l.webhook.party/hook/p8GEvGjZOXrEAnlh9Czg9Tc0iTQBwifuEMuxxUSXDviB6TigfRf2602NP8WKvfbOKbznpmCc84gFdsh3ReH%2BnwfMPy%2FQuxLaSOKoEhONeF2Sa%2BdlaQeZIF8HnyhTdm%2F139Gp1ZQNINg2u5wL4iv3Gnf4vhyNTH6f2v%2BeDX4gF2wk4Ggtz1JckA7wL2zzdEzp7kngu9sT97mMpEQ7hSGib3GfUgQ3XE4yHljVjprjK2vKD1WrJrbkCigxZhM5evlSs0rWFg4vxjo9ytsVdHnbv%2BXF%2FcNb%2BY9c%2Foyj0WNqRrV7WDawmXYGA7%2B1iwKAMhPxDJvGwfytR64FeOoSQdEEfHlk4wKErY6S4Cdvq3FHsDpfrF2Kr3vByaujn%2BhjOUxk51U%2Bf10knUI%3D/O39Ms6oV6RQnZDds';
        const DISCORD_USERNAME = 'Marlowe Vineyard';

        // === TEMPLATE PDF ===
        let templatePDF = null;

        // === FONCTION NETTOYAGE SIMPLE ET EFFICACE ===
       function cleanTextForPDF(text) {
            if (!text) return '';
            
            return String(text)
                // Remplacements s√©curis√©s pour PDF
                
                .replace(/[√†√°√¢√§√£]/gi, 'a')
                .replace(/[√®√©√™√´]/gi, 'e')
                .replace(/[√¨√≠√Æ√Ø]/gi, 'i')
                .replace(/[√≤√≥√¥√∂√µ]/gi, 'o')
                .replace(/[√π√∫√ª√º]/gi, 'u')
                .replace(/[√ß]/gi, 'c')
                .replace(/[√±]/gi, 'n')
                .replace(/[‚Äì‚Äî]/g, '-')
                .replace(/['']/g, "'")
                .replace(/[""]/g, '"')
                // Supprimer les caract√®res probl√©matiques
                .replace(/[^\x20-\x7E\n\r\t]/g, '')
                // Nettoyer les espaces
                .replace(/\s+/g, ' ')
                .trim();
        }
        
        // === FONCTION G√âN√âRATION PDF CORRIG√âE ===
        async function generateMarlowePDFFromTemplate(devisData) {
            if (!templatePDF) {
                throw new Error('Template PDF non charg√©');
            }
            
            try {
                console.log('üìÑ D√©but g√©n√©ration PDF...');
                
                // Cr√©er une copie fra√Æche du template
                const originalPdfBytes = await templatePDF.save();
                console.log('üìÑ Template sauvegard√©:', originalPdfBytes.length, 'bytes');
                
                const pdfDoc = await PDFLib.PDFDocument.load(originalPdfBytes);
                const pages = pdfDoc.getPages();
                const firstPage = pages[0];
                
                // Fonts standards
                const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
                const boldFont = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);
                
                // Nettoyer les donn√©es une seule fois
                const cleanNumero = cleanTextForPDF(devisData.numeroDevis);
                const cleanNom = cleanTextForPDF(devisData.client.nom);
                const cleanAdresse = cleanTextForPDF(devisData.client.adresse);
                const cleanEmail = cleanTextForPDF(devisData.client.email);
                const cleanTelephone = cleanTextForPDF(devisData.client.telephone);
                
                console.log('üìÑ Donn√©es nettoy√©es:', { cleanNumero, cleanNom });
                
                // √âcrire les donn√©es sur le PDF
                if (cleanNumero) {
                    firstPage.drawText(`Devis N¬∞ ${cleanNumero}`, {
                        x: 60, y: 743, size: 14, font: boldFont, color: PDFLib.rgb(1, 1, 1)
                    });
                }
                
                if (cleanNom) {
                    firstPage.drawText(cleanNom, {
                        x: 60, y: 635, size: 11, font: boldFont, color: PDFLib.rgb(0, 0, 0)
                    });
                }
                
                // Adresse avec gestion des erreurs
                if (cleanAdresse) {
                    try {
                        const addressLines = cleanAdresse.split('\n').slice(0, 3);
                        addressLines.forEach((line, index) => {
                            if (line.trim()) {
                                firstPage.drawText(line.trim(), {
                                    x: 60, y: 620 - (index * 15), size: 10, font: font, color: PDFLib.rgb(0, 0, 0)
                                });
                            }
                        });
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Erreur adresse:', e);
                    }
                }
                
                // Contact avec v√©rifications
                let contactY = 605;
                if (cleanEmail) {
                    try {
                        firstPage.drawText(`Email: ${cleanEmail}`, {
                            x: 60, y: contactY, size: 10, font: font, color: PDFLib.rgb(0, 0, 0)
                        });
                        contactY -= 15;
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Erreur email:', e);
                    }
                }
                
                if (cleanTelephone) {
                    try {
                        firstPage.drawText(`Tel: ${cleanTelephone}`, {
                            x: 60, y: contactY, size: 10, font: font, color: PDFLib.rgb(0, 0, 0)
                        });
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Erreur t√©l√©phone:', e);
                    }
                }
                
                // Produits avec s√©curit√© renforc√©e
                let productY = 480;
                if (devisData.produits && Array.isArray(devisData.produits)) {
                    devisData.produits.slice(0, 6).forEach((produit, index) => {
                        try {
                            const currentY = productY - (index * 22);
                            
                            if (currentY > 250) { // √âviter de d√©border
                                const nomProduit = cleanTextForPDF(produit.nom);
                                const nomTronque = nomProduit.length > 30 ? nomProduit.substring(0, 27) + '...' : nomProduit;
                                
                                // Description
                                firstPage.drawText(nomTronque, {
                                    x: 77, y: currentY + 15, size: 10, font: font, color: PDFLib.rgb(0, 0, 0)
                                });
                                
                                // Prix
                                firstPage.drawText(`$${produit.prix || 0}`, {
                                    x: 257, y: currentY + 15, size: 10, font: font, color: PDFLib.rgb(0, 0, 0)
                                });
                                
                                // Quantit√©
                                firstPage.drawText(`${produit.quantite || 1}`, {
                                    x: 397, y: currentY + 15, size: 10, font: font, color: PDFLib.rgb(0, 0, 0)
                                });
                                
                                // Total
                                firstPage.drawText(`$${produit.total || 0}`, {
                                    x: 467, y: currentY + 15, size: 10, font: font, color: PDFLib.rgb(0, 0, 0)
                                });
                            }
                        } catch (e) {
                            console.warn('‚ö†Ô∏è Erreur produit', index, ':', e);
                        }
                    });
                }
                
                // Totaux avec formatage s√©curis√©
                try {
                    const totalsY = 335;
                    const formatAmount = (amount) => {
                        const num = parseFloat(amount) || 0;
                        return Math.round(num * 100) / 100;
                    };
                    
                    // Sous-total
                    firstPage.drawText(`$${formatAmount(devisData.totaux.sousTotal)}`, {
                        x: 467, y: totalsY, size: 11, font: font, color: PDFLib.rgb(0, 0, 0)
                    });
                    
                    // TVA
                    firstPage.drawText(`$${formatAmount(devisData.totaux.tva)}`, {
                        x: 467, y: totalsY - 25, size: 11, font: font, color: PDFLib.rgb(0, 0, 0)
                    });
                    
                    // Total final
                    const totalText = `$${formatAmount(devisData.totaux.total)}`;
                    const totalTextWidth = boldFont.widthOfTextAtSize(totalText, 12);
                    firstPage.drawText(totalText, {
                        x: 520 - totalTextWidth - 10,
                        y: totalsY - 70, 
                        size: 12, 
                        font: boldFont, 
                        color: PDFLib.rgb(1, 1, 1)
                    });
                } catch (e) {
                    console.warn('‚ö†Ô∏è Erreur totaux:', e);
                }
                
                // Date
                try {
                    const today = new Date();
                    const dateStr = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;
                    firstPage.drawText(dateStr, {
                        x: 335, y: 150, size: 10, font: font, color: PDFLib.rgb(0, 0, 0)
                    });
                } catch (e) {
                    console.warn('‚ö†Ô∏è Erreur date:', e);
                }
                
                console.log('‚úÖ PDF g√©n√©r√© avec succ√®s');
                return pdfDoc;
                
            } catch (error) {
                console.error('‚ùå Erreur g√©n√©ration PDF:', error);
                throw new Error(`Erreur PDF: ${error.message}`);
            }
        }

        // === G√âN√âRATION PDF FACTURE ===
        async function generateFacturePDFFromTemplate(factureData) {
            if (!templateFacturePDF) {
                throw new Error('Template PDF facture non charg√©');
            }
            
            try {
                console.log('üìÑ D√©but g√©n√©ration PDF facture...');
                
                const originalPdfBytes = await templateFacturePDF.save();
                const pdfDoc = await PDFLib.PDFDocument.load(originalPdfBytes);
                const pages = pdfDoc.getPages();
                const firstPage = pages[0];
                
                const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
                const boldFont = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);
                
                const cleanNom = cleanTextForPDF(factureData.client.nom);
                const cleanDate = new Date().toLocaleDateString('fr-FR');
                
                // 1. Num√©ro de facture (bulle de gauche sous FACTURE)
                const cleanNumero = cleanTextForPDF(factureData.numeroFacture);
                if (cleanNumero) {
                    firstPage.drawText(cleanNumero, {
                        x: 85, y: 695,
                        size: 11, 
                        font: boldFont, 
                        color: PDFLib.rgb(0, 0, 0)
                    });
                }
                
                // 2. Date (bulle de droite sous FACTURE)
                if (cleanDate) {
                    firstPage.drawText(cleanDate, {
                        x: 220, y: 695,
                        size: 11, 
                        font: font, 
                        color: PDFLib.rgb(0, 0, 0)
                    });
                }

                // 3. Informations client (coordonn√©es temporaires)
                if (cleanNom) {
                    firstPage.drawText(cleanNom, {
                        x: 425, y: 610,
                        size: 11, font: boldFont, color: PDFLib.rgb(0, 0, 0)
                    });
                }
                
                // Adresse client
                const cleanAdresse = cleanTextForPDF(factureData.client.adresse);
                if (cleanAdresse) {
                    try {
                        const addressLines = cleanAdresse.split('\n').slice(0, 3);
                        addressLines.forEach((line, index) => {
                            if (line.trim()) {
                                firstPage.drawText(line.trim(), {
                                    x: 425, y: 595 - (index * 15),
                                    size: 10, font: font, color: PDFLib.rgb(0, 0, 0)
                                });
                            }
                        });
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Erreur adresse facture:', e);
                    }
                }
                
                // Contact client
                const cleanEmail = cleanTextForPDF(factureData.client.email);
                const cleanTelephone = cleanTextForPDF(factureData.client.telephone);
                
                let contactY = 580;
                if (cleanEmail) {
                    firstPage.drawText(`Email: ${cleanEmail}`, {
                        x: 425, y: contactY,
                        size: 10, font: font, color: PDFLib.rgb(0, 0, 0)
                    });
                    contactY -= 15;
                }
                
                if (cleanTelephone) {
                    firstPage.drawText(`Tel: ${cleanTelephone}`, {
                        x: 425, y: contactY,
                        size: 10, font: font, color: PDFLib.rgb(0, 0, 0)
                    });
                }
                
                // 4. Tableau des produits
                let productY = 492;
                if (factureData.produits && Array.isArray(factureData.produits)) {
                    factureData.produits.slice(0, 10).forEach((produit, index) => {
                        try {
                            const currentY = productY - (index * 34);
                            
                            if (currentY > 150) {
                                const nomProduit = cleanTextForPDF(produit.nom);
                                const nomTronque = nomProduit.length > 35 ? nomProduit.substring(0, 32) + '...' : nomProduit;
                                
                                // Description (colonne 1)
                                firstPage.drawText(nomTronque, {
                                    x: 110, y: currentY,
                                    size: 10, font: font, color: PDFLib.rgb(0, 0, 0)
                                });
                                
                                // Prix (colonne 2)
                                firstPage.drawText(`$${produit.prix || 0}`, {
                                    x: 285, y: currentY,
                                    size: 10, font: font, color: PDFLib.rgb(0, 0, 0)
                                });
                                
                                // Quantit√© (colonne 3)
                                firstPage.drawText(`${produit.quantite || 1}`, {
                                    x: 388, y: currentY,
                                    size: 10, font: font, color: PDFLib.rgb(0, 0, 0)
                                });
                                
                                // Total (colonne 4)
                                firstPage.drawText(`$${produit.total || 0}`, {
                                    x: 475, y: currentY,
                                    size: 10, font: font, color: PDFLib.rgb(0, 0, 0)
                                });
                            }
                        } catch (e) {
                            console.warn('‚ö†Ô∏è Erreur produit facture', index, ':', e);
                        }
                    });
                }
                
                // 5. Totaux
                try {
                    const formatAmount = (amount) => {
                        const num = parseFloat(amount) || 0;
                        return Math.round(num * 100) / 100;
                    };
                    
                    // Sous-total
                    firstPage.drawText(`$${formatAmount(factureData.totaux.sousTotal)}`, {
                        x: 480, y: 135,
                        size: 11, font: font, color: PDFLib.rgb(0, 0, 0)
                    });
                    
                    // TVA
                    firstPage.drawText(`$${formatAmount(factureData.totaux.tva)}`, {
                        x: 480, y: 110,
                        size: 11, font: font, color: PDFLib.rgb(0, 0, 0)
                    });
                    
                    // 5. Total final (dans la barre noire en bas)
                    const totalText = `$${formatAmount(factureData.totaux.total)}`;
                    const totalTextWidth = boldFont.widthOfTextAtSize(totalText, 14);
                    firstPage.drawText(totalText, {
                        x: 525 - totalTextWidth,
                        y: 80,
                        size: 14, 
                        font: boldFont, 
                        color: PDFLib.rgb(1, 1, 1)
                    });
                    
                } catch (e) {
                    console.warn('‚ö†Ô∏è Erreur totaux facture:', e);
                }
                
                console.log('‚úÖ PDF facture g√©n√©r√© avec succ√®s');
                return pdfDoc;
                
            } catch (error) {
                console.error('‚ùå Erreur g√©n√©ration PDF facture:', error);
                throw new Error(`Erreur PDF facture: ${error.message}`);
            }
        }
        
        // === CHARGEMENT TEMPLATE ===
        async function tryLoadDefaultTemplate() {
            try {
                showTemplateStatus('üîÑ Chargement du template...', 'info');
                
                const response = await fetch('../assets/template-devis.pdf');
                if (response.ok) {
                    const blob = await response.blob();
                    const arrayBuffer = await blob.arrayBuffer();
                    templatePDF = await PDFLib.PDFDocument.load(arrayBuffer);
                    
                    showTemplateStatus('‚úÖ Template charg√© avec succ√®s', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showTemplateStatus('‚ùå Template non trouv√©', 'error');
            }
        }

        async function tryLoadFactureTemplate() {
            try {
                showTemplateStatus('üîÑ Chargement du template facture...', 'info');
                
                const response = await fetch('../assets/template-factures.pdf');
                if (response.ok) {
                    const blob = await response.blob();
                    const arrayBuffer = await blob.arrayBuffer();
                    templateFacturePDF = await PDFLib.PDFDocument.load(arrayBuffer);
                    
                    showTemplateStatus('‚úÖ Template facture charg√© avec succ√®s', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showTemplateStatus('‚ùå Template facture non trouv√©', 'error');
            }
        }

        function showTemplateStatus(message, type) {
            const statusDiv = document.getElementById('templateStatus');
            const colors = {
                success: '#d4edda; color: #155724',
                error: '#f8d7da; color: #721c24',
                info: '#cce7ff; color: #004085'
            };
            
            statusDiv.innerHTML = `<div style="background: ${colors[type]}; padding: 10px; border-radius: 5px; font-size: 14px;">${message}</div>`;
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Charger le template automatiquement
            tryLoadDefaultTemplate();
            tryLoadFactureTemplate();

            // Gestion des boutons
            document.querySelectorAll('.document-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const documentType = this.dataset.document;
                    
                    if (documentType === 'devis') {
                        if (!templatePDF) {
                            notify.warning('Template manquant', 'Le template PDF n\'est pas encore charg√©.');
                            return;
                        }
                        openDevisForm();
                    } else if (documentType === 'facture') {
                        if (!templateFacturePDF) {
                            notify.warning('Template manquant', 'Le template PDF facture n\'est pas encore charg√©.');
                            return;
                        }
                        openFactureForm();
                    } else {
                        notify.info('En pr√©paration', 'Cette fonctionnalit√© sera bient√¥t disponible !');
                    }
                });
            });

            // Gestion d√©connexion
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                if (confirm('√ätes-vous s√ªr de vouloir vous d√©connecter ?')) {
                    window.location.href = '../index.html';
                }
            });
        });

        // === SYST√àME DE DEVIS ===
        const produits = {
            'marlowe-rouge': { nom: 'Marlowe Rouge Reserve', prix: 450 },
            'marlowe-blanc': { nom: 'Marlowe Blanc Premium', prix: 380 },
            'marlowe-prestige': { nom: 'Marlowe Prestige', prix: 850 },
            'marlowe-rose': { nom: 'Marlowe Rose', prix: 320 },
            'marlowe-vintage': { nom: 'Marlowe Vintage', prix: 1200 },
            'coffret-degustation': { nom: 'Coffret Degustation', prix: 1800 }
        };

        let productCounter = 0;
        let devisData = { client: {}, produits: [], totaux: { sousTotal: 0, tva: 0, total: 0 } };
        let templateFacturePDF = null;  // Template PDF pour les factures
        let factureProductCounter = 0;
        let factureData = { client: {}, produits: [], totaux: { sousTotal: 0, tva: 0, total: 0 } };



        function openDevisForm() {
            document.getElementById('devisModal').style.display = 'flex';
            resetDevisForm();
            generateDevisNumber();
            addProductLine();
            
            document.getElementById('closeDevisModal').onclick = closeDevisModal;
            document.getElementById('cancelDevis').onclick = closeDevisModal;
            document.getElementById('addProductBtn').onclick = addProductLine;
            document.getElementById('generateDevisComplete').onclick = generateDevisComplete;
        }

        function closeDevisModal() {
            document.getElementById('devisModal').style.display = 'none';
        }

        function openFactureForm() {
            document.getElementById('factureModal').style.display = 'flex';
            resetFactureForm();
            generateFactureNumber();
            addFactureProductLine();
            
            document.getElementById('closeFactureModal').onclick = closeFactureModal;
            document.getElementById('cancelFacture').onclick = closeFactureModal;
            document.getElementById('addFactureProductBtn').onclick = addFactureProductLine;
            document.getElementById('generateFactureComplete').onclick = generateFactureComplete;
        }
        
        function closeFactureModal() {
            document.getElementById('factureModal').style.display = 'none';
        }
        
        function resetFactureForm() {
            document.getElementById('facture-client-nom').value = '';
            document.getElementById('facture-client-email').value = '';
            document.getElementById('facture-client-adresse').value = '';
            document.getElementById('facture-client-telephone').value = '';
            document.getElementById('facture-products-container').innerHTML = '';
            factureProductCounter = 0;
            updateFactureTotals();
        }
        
        function generateFactureNumber() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            
            document.getElementById('numero-facture').value = `FA${year}${month}${day}-${random}`;
        }

        function resetDevisForm() {
            document.getElementById('client-nom').value = '';
            document.getElementById('client-email').value = '';
            document.getElementById('client-adresse').value = '';
            document.getElementById('client-telephone').value = '';
            document.getElementById('products-container').innerHTML = '';
            productCounter = 0;
            updateTotals();
        }

        function generateDevisNumber() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            
            document.getElementById('numero-devis').value = `DV${year}${month}${day}-${random}`;
        }

        function addProductLine() {
            productCounter++;
            const container = document.getElementById('products-container');
            
            const productLine = document.createElement('div');
            productLine.className = 'product-line';
            productLine.dataset.id = productCounter;
            
            let buttonHTML = '';
            if (productCounter > 1) {
                buttonHTML = `<button type="button" class="btn-remove-product" onclick="removeProductLine(${productCounter})"><i class="fas fa-trash"></i></button>`;
            }
            
            let optionsHTML = '<option value="">S√©lectionnez un produit</option>';
            Object.entries(produits).forEach(([key, prod]) => {
                optionsHTML += `<option value="${key}">${prod.nom} - $${prod.prix}</option>`;
            });
            
            productLine.innerHTML = `
                <div class="product-line-header">
                    <span class="product-number">Produit ${productCounter}</span>
                    ${buttonHTML}
                </div>
                <div class="form-row">
                    <div class="form-group flex-2">
                        <label class="form-label">Produit</label>
                        <select class="form-select product-select" data-id="${productCounter}" onchange="updateProductPrice(${productCounter})">
                            ${optionsHTML}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Prix unitaire</label>
                        <input type="text" class="form-input product-price" data-id="${productCounter}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quantit√©</label>
                        <input type="number" class="form-input product-quantity" data-id="${productCounter}" min="1" value="1" onchange="updateLineTotal(${productCounter})">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Total HT</label>
                        <input type="text" class="form-input product-total" data-id="${productCounter}" readonly>
                    </div>
                </div>
            `;
            
            container.appendChild(productLine);
        }

        function removeProductLine(id) {
            const line = document.querySelector(`[data-id="${id}"]`);
            if (line) {
                line.remove();
                updateTotals();
            }
        }

        function updateProductPrice(id) {
            const select = document.querySelector(`select[data-id="${id}"]`);
            const priceInput = document.querySelector(`input.product-price[data-id="${id}"]`);
            
            if (select.value) {
                const prix = produits[select.value].prix;
                priceInput.value = `${prix}.00`;
                updateLineTotal(id);
            } else {
                priceInput.value = '';
                updateLineTotal(id);
            }
        }

        function updateLineTotal(id) {
            const select = document.querySelector(`select[data-id="${id}"]`);
            const quantityInput = document.querySelector(`input.product-quantity[data-id="${id}"]`);
            const totalInput = document.querySelector(`input.product-total[data-id="${id}"]`);
            
            if (select.value && quantityInput.value) {
                const prix = produits[select.value].prix;
                const quantity = parseInt(quantityInput.value) || 0;
                const total = prix * quantity;
                
                totalInput.value = `${total.toLocaleString('en-US')}.00`;
            } else {
                totalInput.value = '';
            }
            
            updateTotals();
        }

        function updateTotals() {
            let sousTotal = 0;
            
            document.querySelectorAll('.product-line').forEach(line => {
                const id = line.dataset.id;
                const select = document.querySelector(`select[data-id="${id}"]`);
                const quantityInput = document.querySelector(`input.product-quantity[data-id="${id}"]`);
                
                if (select && select.value && quantityInput && quantityInput.value) {
                    const prix = produits[select.value].prix;
                    const quantity = parseInt(quantityInput.value) || 0;
                    sousTotal += prix * quantity;
                }
            });
            
            const tva = sousTotal * 0.21;
            const total = sousTotal + tva;
            
            document.getElementById('sous-total').textContent = `${sousTotal.toLocaleString('en-US')}.00`;
            document.getElementById('tva-montant').textContent = `${tva.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('total-final').textContent = `${total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            
            devisData.totaux = { sousTotal, tva, total };
        }

        // === GESTION PRODUITS FACTURE ===
        function addFactureProductLine() {
            factureProductCounter++;
            const container = document.getElementById('facture-products-container');
            
            const productLine = document.createElement('div');
            productLine.className = 'product-line';
            productLine.dataset.id = factureProductCounter;
            
            let buttonHTML = '';
            if (factureProductCounter > 1) {
                buttonHTML = `<button type="button" class="btn-remove-product" onclick="removeFactureProductLine(${factureProductCounter})"><i class="fas fa-trash"></i></button>`;
            }
            
            let optionsHTML = '<option value="">S√©lectionnez un produit</option>';
            Object.entries(produits).forEach(([key, prod]) => {
                optionsHTML += `<option value="${key}">${prod.nom} - $${prod.prix}</option>`;
            });
            
            productLine.innerHTML = `
                <div class="product-line-header">
                    <span class="product-number">Produit ${factureProductCounter}</span>
                    ${buttonHTML}
                </div>
                <div class="form-row">
                    <div class="form-group flex-2">
                        <label class="form-label">Produit</label>
                        <select class="form-select product-select" data-id="${factureProductCounter}" onchange="updateFactureProductPrice(${factureProductCounter})">
                            ${optionsHTML}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Prix unitaire</label>
                        <input type="text" class="form-input product-price" data-id="${factureProductCounter}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quantit√©</label>
                        <input type="number" class="form-input product-quantity" data-id="${factureProductCounter}" min="1" value="1" onchange="updateFactureLineTotal(${factureProductCounter})">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Total HT</label>
                        <input type="text" class="form-input product-total" data-id="${factureProductCounter}" readonly>
                    </div>
                </div>
            `;
            
            container.appendChild(productLine);
        }
        
        function removeFactureProductLine(id) {
            const line = document.querySelector(`#facture-products-container [data-id="${id}"]`);
            if (line) {
                line.remove();
                updateFactureTotals();
            }
        }
        
        function updateFactureProductPrice(id) {
            const select = document.querySelector(`#facture-products-container select[data-id="${id}"]`);
            const priceInput = document.querySelector(`#facture-products-container input.product-price[data-id="${id}"]`);
            
            if (select.value) {
                const prix = produits[select.value].prix;
                priceInput.value = `${prix}.00`;
                updateFactureLineTotal(id);
            } else {
                priceInput.value = '';
                updateFactureLineTotal(id);
            }
        }
        
        function updateFactureLineTotal(id) {
            const select = document.querySelector(`#facture-products-container select[data-id="${id}"]`);
            const quantityInput = document.querySelector(`#facture-products-container input.product-quantity[data-id="${id}"]`);
            const totalInput = document.querySelector(`#facture-products-container input.product-total[data-id="${id}"]`);
            
            if (select.value && quantityInput.value) {
                const prix = produits[select.value].prix;
                const quantity = parseInt(quantityInput.value) || 0;
                const total = prix * quantity;
                
                totalInput.value = `${total.toLocaleString('en-US')}.00`;
            } else {
                totalInput.value = '';
            }
            
            updateFactureTotals();
        }
        
        function updateFactureTotals() {
            let sousTotal = 0;
            
            document.querySelectorAll('#facture-products-container .product-line').forEach(line => {
                const id = line.dataset.id;
                const select = document.querySelector(`#facture-products-container select[data-id="${id}"]`);
                const quantityInput = document.querySelector(`#facture-products-container input.product-quantity[data-id="${id}"]`);
                
                if (select && select.value && quantityInput && quantityInput.value) {
                    const prix = produits[select.value].prix;
                    const quantity = parseInt(quantityInput.value) || 0;
                    sousTotal += prix * quantity;
                }
            });
            
            const tva = sousTotal * 0.21;
            const total = sousTotal + tva;
            
            document.getElementById('facture-sous-total').textContent = `${sousTotal.toLocaleString('en-US')}.00`;
            document.getElementById('facture-tva-montant').textContent = `${tva.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('facture-total-final').textContent = `${total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            
            factureData.totaux = { sousTotal, tva, total };
        }

        function collectDevisData() {
            devisData.client = {
                nom: document.getElementById('client-nom').value,
                email: document.getElementById('client-email').value,
                adresse: document.getElementById('client-adresse').value,
                telephone: document.getElementById('client-telephone').value
            };
            
            devisData.numeroDevis = document.getElementById('numero-devis').value;
            
            devisData.produits = [];
            document.querySelectorAll('.product-line').forEach(line => {
                const id = line.dataset.id;
                const select = document.querySelector(`select[data-id="${id}"]`);
                const quantityInput = document.querySelector(`input.product-quantity[data-id="${id}"]`);
                
                if (select && select.value && quantityInput && quantityInput.value) {
                    const produit = produits[select.value];
                    const quantity = parseInt(quantityInput.value);
                    const total = produit.prix * quantity;
                    
                    devisData.produits.push({
                        nom: produit.nom,
                        prix: produit.prix,
                        quantite: quantity,
                        total: total
                    });
                }
            });
        }

        function collectFactureData() {
            factureData.client = {
                nom: document.getElementById('facture-client-nom').value,
                email: document.getElementById('facture-client-email').value,
                adresse: document.getElementById('facture-client-adresse').value,
                telephone: document.getElementById('facture-client-telephone').value
            };
            
            factureData.numeroFacture = document.getElementById('numero-facture').value;
            factureData.dateEmission = new Date().toISOString().split('T')[0];
            
            factureData.produits = [];
            document.querySelectorAll('#facture-products-container .product-line').forEach(line => {
                const id = line.dataset.id;
                const select = document.querySelector(`#facture-products-container select[data-id="${id}"]`);
                const quantityInput = document.querySelector(`#facture-products-container input.product-quantity[data-id="${id}"]`);
                
                if (select && select.value && quantityInput && quantityInput.value) {
                    const produit = produits[select.value];
                    const quantity = parseInt(quantityInput.value);
                    const total = produit.prix * quantity;
                    
                    factureData.produits.push({
                        nom: produit.nom,
                        prix: produit.prix,
                        quantite: quantity,
                        total: total
                    });
                }
            });
        }
        
        async function generateFactureComplete() {
            console.log('üöÄ G√©n√©ration compl√®te de la facture...');
            
            if (!document.getElementById('facture-client-nom').value.trim()) {
                notify.error('Formulaire incomplet', 'Le nom du client est requis.');
                return;
            }
            
            if (!document.getElementById('facture-client-adresse').value.trim()) {
                notify.error('Formulaire incomplet', 'L\'adresse du client est requise.');
                return;
            }
            
            if (!templateFacturePDF) {
                notify.error('Template manquant', 'Le template PDF facture n\'est pas charg√©.');
                return;
            }
            
            let hasValidProducts = false;
            document.querySelectorAll('#facture-products-container .product-line').forEach(line => {
                const id = line.dataset.id;
                const select = document.querySelector(`#facture-products-container select[data-id="${id}"]`);
                if (select && select.value) hasValidProducts = true;
            });
            
            if (!hasValidProducts) {
                notify.error('Aucun produit', 'Veuillez s√©lectionner au moins un produit.');
                return;
            }
            
            collectFactureData();
            console.log('üìä Donn√©es de la facture:', factureData);
            
            try {
                notify.info('Traitement en cours...', 'G√©n√©ration du PDF facture...');
                
                const filename = await downloadFacturePDF(factureData);
                console.log('‚úÖ PDF facture t√©l√©charg√©:', filename);
                
                notify.info('Notification Discord...', 'Envoi en cours...');
                
                await sendFactureToDiscord(factureData);
                console.log('‚úÖ Discord notifi√© pour la facture');
                
                notify.success(
                    'Facture cr√©√©e avec succ√®s !', 
                    `‚Ä¢ PDF t√©l√©charg√©: ${filename}\n‚Ä¢ Notification Discord envoy√©e\n‚Ä¢ Facture ${factureData.numeroFacture} √©mise`
                );
                
                setTimeout(() => closeFactureModal(), 3000);
                
            } catch (error) {
                console.error('‚ùå Erreur compl√®te facture:', error);
                
                if (error.message.includes('Discord')) {
                    notify.error('Erreur Discord', 'Le PDF a √©t√© t√©l√©charg√© mais l\'envoi Discord a √©chou√©.');
                } else {
                    notify.error('Erreur de g√©n√©ration', error.message);
                }
            }
        }

        // === FONCTION ENVOI DISCORD SIMPLIFI√â (EMBED SEULEMENT) ===
        async function sendEmbedToDiscord(devisData) {
            if (!DISCORD_WEBHOOK_URL || DISCORD_WEBHOOK_URL.includes('VOTRE_WEBHOOK_URL_ICI')) {
                throw new Error('Webhook Discord non configur√©');
            }
            
            try {
                console.log('üì§ Envoi embed Discord d√©taill√©...');
                
                // Nettoyer les donn√©es
                const safeData = {
                    numero: String(devisData.numeroDevis || 'N/A'),
                    client: String(devisData.client?.nom || 'Client'),
                    email: String(devisData.client?.email || ''),
                    telephone: String(devisData.client?.telephone || ''),
                    adresse: String(devisData.client?.adresse || ''),
                    total: parseFloat(devisData.totaux?.total || 0),
                    sousTotal: parseFloat(devisData.totaux?.sousTotal || 0),
                    tva: parseFloat(devisData.totaux?.tva || 0)
                };
                
                // Construire la liste des produits d√©taill√©e
                let produitsDescription = '';
                if (devisData.produits && Array.isArray(devisData.produits) && devisData.produits.length > 0) {
                    devisData.produits.forEach(produit => {
                        const nom = String(produit.nom || 'Produit');
                        const qty = parseInt(produit.quantite) || 1;
                        const prix = parseFloat(produit.prix) || 0;
                        const total = parseFloat(produit.total) || 0;
                        
                        produitsDescription += `‚Ä¢ **${nom}** (${qty}x) - $${prix.toFixed(2)} = $${total.toFixed(2)}\n`;
                    });
                }
                
                // Construire les informations client
                let clientInfo = '';
                if (safeData.email) clientInfo += `üìß ${safeData.email}\n`;
                if (safeData.telephone) clientInfo += `üìû ${safeData.telephone}\n`;
                if (safeData.adresse) {
                    const adresseFormatted = safeData.adresse.replace(/\n/g, ', ');
                    clientInfo += `üìç ${adresseFormatted}`;
                }
                
                // Cr√©er l'embed principal
                const embed = {
                    title: "üç∑ Nouveau Devis Marlowe Vineyard",
                    description: `Devis g√©n√©r√© automatiquement le ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}`,
                    color: 0x8B5A9F,
                    fields: [
                        {
                            name: "üìã Num√©ro de devis",
                            value: `\`${safeData.numero}\``,
                            inline: true
                        },
                        {
                            name: "üë§ Client",
                            value: `**${safeData.client}**`,
                            inline: true
                        },
                        {
                            name: "üí∞ Montant total",
                            value: `**$${safeData.total.toLocaleString('en-US', {minimumFractionDigits: 2})}**`,
                            inline: true
                        }
                    ],
                    timestamp: new Date().toISOString(),
                    footer: {
                        text: "Marlowe Vineyard ‚Ä¢ Syst√®me de gestion",
                        icon_url: null
                    }
                };
                
                // Ajouter les informations client si disponibles
                if (clientInfo.trim()) {
                    embed.fields.push({
                        name: "üìá Informations client",
                        value: clientInfo.trim(),
                        inline: false
                    });
                }
                
                // Ajouter la liste d√©taill√©e des produits
                if (produitsDescription) {
                    // Si trop long, tronquer intelligemment
                    if (produitsDescription.length > 1000) {
                        const lines = produitsDescription.split('\n');
                        let truncated = '';
                        for (let i = 0; i < lines.length && truncated.length < 900; i++) {
                            truncated += lines[i] + '\n';
                        }
                        if (lines.length > Math.floor(900 / 50)) { // Estimation du nombre de lignes tronqu√©es
                            truncated += `... et ${devisData.produits.length - Math.floor(900 / 50)} autres produits`;
                        }
                        produitsDescription = truncated;
                    }
                    
                    embed.fields.push({
                        name: `üõí Produits command√©s (${devisData.produits.length})`,
                        value: produitsDescription,
                        inline: false
                    });
                }
                
                // Ajouter le d√©tail financier
                embed.fields.push({
                    name: "üßÆ D√©tail financier",
                    value: `**Sous-total HT:** $${safeData.sousTotal.toLocaleString('en-US', {minimumFractionDigits: 2})}\n` +
                           `**TVA (21%):** $${safeData.tva.toLocaleString('en-US', {minimumFractionDigits: 2})}\n` +
                           `**Total TTC:** $${safeData.total.toLocaleString('en-US', {minimumFractionDigits: 2})}`,
                    inline: false
                });
                
                // Payload final
                const payload = {
                    content: "üìã **Nouveau devis cr√©√© !**\n> Un nouveau devis vient d'√™tre g√©n√©r√© et t√©l√©charg√© automatiquement.",
                    embeds: [embed],
                    username: "Marlowe Vineyard",
                    avatar_url: null // Vous pouvez ajouter une URL d'avatar ici si vous voulez
                };
                
                console.log('üì§ Envoi embed d√©taill√© vers Discord...');
                
                // Envoyer l'embed
                const response = await fetch(DISCORD_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Erreur Discord:', response.status, errorText);
                    throw new Error(`Discord error: ${response.status} - ${errorText}`);
                }
                
                console.log('‚úÖ Embed d√©taill√© envoy√© avec succ√®s sur Discord');
                return true;
                
            } catch (error) {
                console.error('‚ùå Erreur envoi Discord:', error);
                throw error;
            }
        }

        // === ENVOI DISCORD FACTURE ===
        async function sendFactureToDiscord(factureData) {
            if (!DISCORD_WEBHOOK_URL || DISCORD_WEBHOOK_URL.includes('VOTRE_WEBHOOK_URL_ICI')) {
                throw new Error('Webhook Discord non configur√©');
            }
            
            try {
                console.log('üì§ Envoi facture Discord...');
                
                const safeData = {
                    numero: String(factureData.numeroFacture || 'N/A'),
                    client: String(factureData.client?.nom || 'Client'),
                    email: String(factureData.client?.email || ''),
                    telephone: String(factureData.client?.telephone || ''),
                    adresse: String(factureData.client?.adresse || ''),
                    total: parseFloat(factureData.totaux?.total || 0),
                    sousTotal: parseFloat(factureData.totaux?.sousTotal || 0),
                    tva: parseFloat(factureData.totaux?.tva || 0),
                    dateEmission: factureData.dateEmission || new Date().toISOString().split('T')[0]
                };
                
                let produitsDescription = '';
                if (factureData.produits && Array.isArray(factureData.produits) && factureData.produits.length > 0) {
                    factureData.produits.forEach(produit => {
                        const nom = String(produit.nom || 'Produit');
                        const qty = parseInt(produit.quantite) || 1;
                        const prix = parseFloat(produit.prix) || 0;
                        const total = parseFloat(produit.total) || 0;
                        
                        produitsDescription += `‚Ä¢ **${nom}** (${qty}x) - $${prix.toFixed(2)} = $${total.toFixed(2)}\n`;
                    });
                }
                
                let clientInfo = '';
                if (safeData.email) clientInfo += `üìß ${safeData.email}\n`;
                if (safeData.telephone) clientInfo += `üìû ${safeData.telephone}\n`;
                if (safeData.adresse) {
                    const adresseFormatted = safeData.adresse.replace(/\n/g, ', ');
                    clientInfo += `üìç ${adresseFormatted}`;
                }
                
                const embed = {
                    title: "üßæ Nouvelle Facture Marlowe Vineyard",
                    description: `Facture √©mise le ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}`,
                    color: 0xDC3545,
                    fields: [
                        {
                            name: "üìã Num√©ro de facture",
                            value: `\`${safeData.numero}\``,
                            inline: true
                        },
                        {
                            name: "üë§ Client",
                            value: `**${safeData.client}**`,
                            inline: true
                        },
                        {
                            name: "üí∞ Montant √† payer",
                            value: `**$${safeData.total.toLocaleString('en-US', {minimumFractionDigits: 2})}**`,
                            inline: true
                        },
                        {
                            name: "üìÖ Date d'√©mission",
                            value: new Date(safeData.dateEmission).toLocaleDateString('fr-FR'),
                            inline: true
                        },
                        {
                            name: "‚è∞ √âch√©ance",
                            value: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toLocaleDateString('fr-FR'),
                            inline: true
                        },
                        {
                            name: "üìä Statut",
                            value: "üî¥ **√Ä PAYER**",
                            inline: true
                        }
                    ],
                    timestamp: new Date().toISOString(),
                    footer: {
                        text: "Marlowe Vineyard ‚Ä¢ Facturation",
                        icon_url: null
                    }
                };
                
                if (clientInfo.trim()) {
                    embed.fields.push({
                        name: "üìá Informations client",
                        value: clientInfo.trim(),
                        inline: false
                    });
                }
                
                if (produitsDescription) {
                    if (produitsDescription.length > 1000) {
                        const lines = produitsDescription.split('\n');
                        let truncated = '';
                        for (let i = 0; i < lines.length && truncated.length < 900; i++) {
                            truncated += lines[i] + '\n';
                        }
                        if (lines.length > Math.floor(900 / 50)) {
                            truncated += `... et ${factureData.produits.length - Math.floor(900 / 50)} autres produits`;
                        }
                        produitsDescription = truncated;
                    }
                    
                    embed.fields.push({
                        name: `üõí Produits factur√©s (${factureData.produits.length})`,
                        value: produitsDescription,
                        inline: false
                    });
                }
                
                embed.fields.push({
                    name: "üßÆ D√©tail financier",
                    value: `**Sous-total HT:** $${safeData.sousTotal.toLocaleString('en-US', {minimumFractionDigits: 2})}\n` +
                           `**TVA (21%):** $${safeData.tva.toLocaleString('en-US', {minimumFractionDigits: 2})}\n` +
                           `**Total TTC:** $${safeData.total.toLocaleString('en-US', {minimumFractionDigits: 2})}`,
                    inline: false
                });
                
                const payload = {
                    content: "üßæ **Nouvelle facture √©mise !**\n> Une facture vient d'√™tre g√©n√©r√©e et est en attente de paiement.",
                    embeds: [embed],
                    username: "Marlowe Vineyard - Facturation"
                };
                
                const response = await fetch(DISCORD_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Erreur Discord:', response.status, errorText);
                    throw new Error(`Discord error: ${response.status} - ${errorText}`);
                }
                
                console.log('‚úÖ Facture envoy√©e avec succ√®s sur Discord');
                return true;
                
            } catch (error) {
                console.error('‚ùå Erreur envoi Discord facture:', error);
                throw error;
            }
        }
        
        async function downloadPDF(devisData) {
            try {
                console.log('üìÑ G√©n√©ration PDF pour t√©l√©chargement...');
                
                const pdfDoc = await generateMarlowePDFFromTemplate(devisData);
                const pdfBytes = await pdfDoc.save();
                
                console.log('üìÑ PDF g√©n√©r√©:', pdfBytes.length, 'bytes');
                
                const pdfBlob = new Blob([pdfBytes], { type: 'application/pdf' });
                
                const clientName = devisData.client.nom
                    .replace(/[^a-zA-Z0-9\s]/g, '')
                    .replace(/\s+/g, '_')
                    .substring(0, 20);
                
                const filename = `Devis_${devisData.numeroDevis}_${clientName}.pdf`;
                
                const url = URL.createObjectURL(pdfBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.style.display = 'none';
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                setTimeout(() => URL.revokeObjectURL(url), 1000);
                
                console.log('‚úÖ PDF t√©l√©charg√©:', filename);
                return filename;
                
            } catch (error) {
                console.error('‚ùå Erreur t√©l√©chargement PDF:', error);
                throw error;
            }
        }

        async function downloadFacturePDF(factureData) {
            try {
                console.log('üìÑ G√©n√©ration PDF facture pour t√©l√©chargement...');
                
                const pdfDoc = await generateFacturePDFFromTemplate(factureData);
                const pdfBytes = await pdfDoc.save();
                
                console.log('üìÑ PDF facture g√©n√©r√©:', pdfBytes.length, 'bytes');
                
                const pdfBlob = new Blob([pdfBytes], { type: 'application/pdf' });
                
                const clientName = factureData.client.nom
                    .replace(/[^a-zA-Z0-9\s]/g, '')
                    .replace(/\s+/g, '_')
                    .substring(0, 20);
                
                const filename = `Facture_${factureData.numeroFacture}_${clientName}.pdf`;
                
                const url = URL.createObjectURL(pdfBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.style.display = 'none';
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                setTimeout(() => URL.revokeObjectURL(url), 1000);
                
                console.log('‚úÖ PDF facture t√©l√©charg√©:', filename);
                return filename;
                
            } catch (error) {
                console.error('‚ùå Erreur t√©l√©chargement PDF facture:', error);
                throw error;
            }
        }
        
        // === FONCTION PRINCIPALE (INCHANG√âE) ===
        async function generateDevisComplete() {
            console.log('üöÄ G√©n√©ration compl√®te du devis...');
            
            if (!document.getElementById('client-nom').value.trim()) {
                notify.error('Formulaire incomplet', 'Le nom du client est requis.');
                return;
            }
            
            if (!document.getElementById('client-adresse').value.trim()) {
                notify.error('Formulaire incomplet', 'L\'adresse du client est requise.');
                return;
            }
            
            if (!templatePDF) {
                notify.error('Template manquant', 'Le template PDF n\'est pas charg√©.');
                return;
            }
            
            let hasValidProducts = false;
            document.querySelectorAll('.product-line').forEach(line => {
                const id = line.dataset.id;
                const select = document.querySelector(`select[data-id="${id}"]`);
                if (select && select.value) hasValidProducts = true;
            });
            
            if (!hasValidProducts) {
                notify.error('Aucun produit', 'Veuillez s√©lectionner au moins un produit.');
                return;
            }
            
            collectDevisData();
            console.log('üìä Donn√©es du devis:', devisData);
            
            try {
                notify.info('Traitement en cours...', 'G√©n√©ration du PDF...');
                
                const filename = await downloadPDF(devisData);
                console.log('‚úÖ PDF t√©l√©charg√©:', filename);
                
                notify.info('Notification Discord...', 'Envoi en cours...');
                
                await sendEmbedToDiscord(devisData);
                console.log('‚úÖ Discord notifi√©');
                
                notify.success(
                    'Devis cr√©√© avec succ√®s !', 
                    `‚Ä¢ PDF t√©l√©charg√©: ${filename}\n‚Ä¢ Notification Discord envoy√©e\n‚Ä¢ Devis ${devisData.numeroDevis} finalis√©`
                );
                
                setTimeout(() => closeDevisModal(), 3000);
                
            } catch (error) {
                console.error('‚ùå Erreur compl√®te:', error);
                
                if (error.message.includes('Discord')) {
                    notify.error('Erreur Discord', 'Le PDF a √©t√© t√©l√©charg√© mais l\'envoi Discord a √©chou√©. V√©rifiez la console.');
                } else {
                    notify.error('Erreur de g√©n√©ration', error.message);
                }
            }
        }
    </script>
</body>
</html>
